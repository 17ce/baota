var bt_file={area:[],loadT:null,loadY:null,vscode:null,file_table_arry:[],timerM:null,is_update_down_list:!0,is_recycle:!1,is_editor:!1,file_table:{file_checkbox:40,file_name:"auto",file_type:100,file_size:100,file_mtime:180,file_accept:80,file_user:80,file_ps:150},file_operating:[],file_pointer:-1,file_path:"C:/",file_page_num:bt.get_storage("local","showRow")||100,file_list:[],file_store_list:[],file_store_current:0,file_images_list:[],file_drop:null,file_present_task:null,file_selection_operating:[],file_share_list:[],method_list:{GetFileBody:"获取文件内容",DeleteDir:"删除文件目录",DeleteFile:"删除文件",GetDiskInfo:["system","获取磁盘列表"],CheckExistsFiles:"检测同名文件是否存在",GetFileAccess:"获取文件权限信息",SetFileAccess:lan.public.config,DelFileAccess:"正在删除用户",get_path_size:"获取文件目录大小",add_files_store_types:"创建收藏夹分类",get_files_store:"获取收藏夹列表",del_files_store:"取消文件收藏",dir_webshell_check:"目录查杀",file_webshell_check:"查杀文件",get_download_url_list:"获取外链分享列表",get_download_url_find:"获取指定外链分享信息",create_download_url:"创建外链分享",remove_download_url:"取消外链分享",add_files_store:"添加文件收藏",CopyFile:"复制文件",MvFile:"剪切文件",SetBatchData:"执行批量操作",Get_Recycle_bin:"回收站列表",BatchPaste:"粘贴中"},init:function(){null!=bt.get_cookie("rank")&&null!=bt.get_cookie("rank")&&"a"!=bt.get_cookie("rank")&&"b"!=bt.get_cookie("rank")||bt.set_cookie("rank","list"),this.area=[window.innerWidth,window.innerHeight],this.file_path=bt.get_cookie("Path"),this.event_bind(),this.reader_file_list({is_operating:!0}),this.render_file_disk_list(),this.file_drop.init(),this.set_file_table_width()},event_bind:function(){var that=this;$(window).resize((function(ev){$(this)[0].innerHeight!=that.area[1]&&(that.area[1]=$(this)[0].innerHeight,that.set_file_view()),$(this)[0].innerWidth!=that.area[0]&&(that.area[0]=$(this)[0].innerWidth,that.set_dir_view_resize(),that.set_menu_line_view_resize(),that.set_file_table_width())})).keydown((function(e){var keyCode=(e=window.event||e).keyCode,tagName=e.target.tagName.toLowerCase();that.is_editor||(e.ctrlKey&&86==keyCode&&"input"!=tagName&&"textarea"!=tagName&&that.paste_file_or_dir(),8==keyCode&&"input"!==tagName&&"textarea"!==tagName&&void 0===$(e.target).attr("data-backspace")&&$(".file_return_level").click())})),$(".search_path_views").on("click",".is_search_children",(function(e){var box=$(this).siblings(".file_search_config");box.hasClass("hide")?box.removeClass("hide"):box.addClass("hide"),box.find("label").unbind("click").click((function(){$(this).siblings(".file_search_checked").click()})),box.find(".file_search_checked").unbind("click").click((function(){$(this).hasClass("active")?$(this).removeClass("active"):$(this).addClass("active")})),e.stopPropagation()})),$(".search_path_views").on("click",".path_btn",(function(e){var _obj={path:that.file_path,search:$(".file_search_input").val()},isCheck;$(".file_search_checked").hasClass("active")&&(_obj.all="True"),that.loadT=bt.load("正在搜索文件中,请稍候..."),that.reader_file_list(_obj,(function(res){res.msg||that.loadT.close()})),$(".file_search_config").addClass("hide"),e.stopPropagation()})),$(".search_path_views .file_search_input").on("focus keyup",(function(e){e=e||window.event;var _obj={path:that.file_path,search:$(this).val()};switch(e.type){case"focus":$(".file_search_config").addClass("hide");break;case"keyup":var isCheck;if($(".file_search_checked").hasClass("active")&&(_obj.all="True"),13!=e.keyCode&&"keyup"==e.type)return!1;that.loadT=bt.load("正在搜索文件中,请稍候..."),that.reader_file_list(_obj,(function(res){res.msg||that.loadT.close()}))}e.stopPropagation(),e.preventDefault()})),$(".file_path_input .path_input").on("focus blur keyup",(function(e){e=e||window.event;var path=$(this).attr("data-path"),_this=$(this);switch(e.type){case"focus":$(this).addClass("focus").val(path).prev().hide();break;case"blur":$(this).removeClass("focus").val("").prev().show();break;case"keyup":if(13!=e.keyCode&&"keyup"==e.type)return!1;$(this).data("path")!=$(this).val()&&that.reader_file_list({path:that.path_check($(this).val()),is_operating:!0},(function(res){!1===res.status?_this.val(path):(_this.val(that.path_check(res.PATH)),_this.blur().prev().show())}))}e.stopPropagation()})),$(".file_path_input .file_dir_view").on("click",".file_dir",(function(){that.reader_file_list({path:$(this).attr("title"),is_operating:!0})})),$(".forward_path span").click((function(){var index=$(this).index(),path="";if(!$(this).hasClass("active")){switch(index){case 0:that.file_pointer=that.file_pointer-1,path=that.file_operating[that.file_pointer];break;case 1:that.file_pointer=that.file_pointer+1,path=that.file_operating[that.file_pointer]}that.reader_file_list({path:path,is_operating:!1})}})),$(".file_path_input .file_dir_view").on("click",".file_dir_omit",(function(e){var _this=this,new_down_list=$(this).children(".nav_down_list");$(this).addClass("active"),new_down_list.addClass("show"),$(document).one("click",(function(){$(_this).removeClass("active"),new_down_list.removeClass("show"),e.stopPropagation()})),e.stopPropagation()})),$(".file_path_input .file_dir_view").on("click",".file_dir_item i",(function(e){var children_list=$(this).siblings(".nav_down_list"),_path=$(this).siblings("span").attr("title");children_list.show().parent().siblings().find(".nav_down_list").removeAttr("style"),that.render_path_down_list(children_list,_path),$(document).one("click",(function(){children_list.removeAttr("style"),e.stopPropagation()})),e.stopPropagation()})),$(".file_path_input .file_dir_view").on("click",".file_dir_item .nav_down_list li",(function(e){that.reader_file_list({path:$(this).data("path"),is_operating:!0})})),$(".file_return_level").click((function(){that.reader_file_list({path:that.retrun_prev_path(that.file_path),is_operating:!0})})),$(".file_path_refresh").click((function(){that.reader_file_list({path:that.file_path},(function(res){res.msg||layer.msg("刷新成功")}))})),$(".file_nav_view .upload_or_download li").on("click",(function(e){var type;"uploadFile"===$(this).data("type")?that.file_drop.dialog_view():that.open_download_view(),e.stopPropagation(),e.preventDefault()})),$(".file_nav_view .create_file_or_dir li").on("click",(function(e){var type=$(this).data("type"),nav_down_list=$(".create_file_or_dir .nav_down_list");if(nav_down_list.css({display:function(){return setTimeout((function(){nav_down_list.removeAttr("style")}),100),"none"}}),that.is_editor)return!1;that.is_editor=!0,$(".file_list_content").prepend('<div class="file_tr createModel active"><div class="file_td file_checkbox"></div><div class="file_td file_name"><div class="file_ico_type"><i class="file_icon '+("newBlankDir"==type?"file_folder":"")+'"></i></div>'+("icon"==bt.get_cookie("rank")?'<span class="file_title file_'+("newBlankDir"==type?"dir":"file")+'_status"><textarea name="createArea" onfocus="select()">'+("newBlankDir"==type?"新建文件夹":"新建文件")+"</textarea></span>":'<span class="file_title file_'+("newBlankDir"==type?"dir":"file")+'_status"><input name="createArea" value="'+("newBlankDir"==type?"新建文件夹":"新建文件")+'" onfocus="select()" type="text"></span>')+"</div></div>"),$(("icon"==bt.get_cookie("rank")?"textarea":"input")+"[name=createArea]").on("input",(function(){"icon"==bt.get_cookie("rank")&&(this.style.height="auto",this.style.height=this.scrollHeight+"px")})).keyup((function(e){13==e.keyCode&&$(this).blur()})).blur((function(e){var _val=$(this).val().replace(/[\r\n]/g,"");if(that.match_unqualified_string(_val))return layer.msg('名称不能含有 /\\:*?"<>|符号',{icon:2});""==_val&&(_val="newBlankDir"==type?"新建文件夹":"新建文件"),setTimeout((function(){that.create_file_req({type:"newBlankDir"==type?"folder":"file",path:that.file_path+"/"+_val},(function(res){res.status&&that.reader_file_list({path:that.file_path}),layer.msg(res.msg,{icon:res.status?1:2})})),$(".createModel").remove(),that.is_editor=!1}),300),e.preventDefault()})).focus(),e.stopPropagation(),e.preventDefault()})),$(".file_nav_view .favorites_file_path ul").on("click","li",(function(e){var _href=$(this).data("path"),_type=$(this).data("type"),nav_down_list=$(".favorites_file_path .nav_down_list");if("dir"==_type)that.reader_file_list({path:_href,is_operating:!0});else{if(null!=$(this).data("null"))return!1;var _file=$(this).attr("title").split("."),_fileT=_file[_file.length-1],_fileE;switch(that.determine_file_type(_fileT)){case"text":openEditorView(0,_href);break;case"video":that.open_video_play(_href);break;case"images":that.open_images_preview({filename:$(this).attr("title"),path:_href});break;default:that.reader_file_list({path:that.retrun_prev_path(_href),is_operating:!0})}}nav_down_list.css({display:function(){return setTimeout((function(){nav_down_list.removeAttr("style")}),100),"none"}}),e.stopPropagation(),e.preventDefault()})),$(".share_file_list").on("click",(function(){that.open_share_view()})),$(".mount_disk_list").on("click",".nav_btn",(function(){var path=$(this).data("menu");that.reader_file_list({path:path,is_operating:!0})})),$(".mount_disk_list").on("click",".nav_down_list li",(function(){var path=$(this).data("disk"),disk_list=$(".mount_disk_list.thezoom .nav_down_list");disk_list.css({display:function(){return setTimeout((function(){disk_list.removeAttr("style")}),100),"none"}}),that.reader_file_list({path:path,is_operating:!0})})),$(".file_nav_view").on("click",".recycle_bin",(function(ev){that.recycle_bin_view(),ev.stopPropagation(),ev.preventDefault()})),$(".file_nav_view .multi").on("click",".nav_btn_group",(function(ev){var batch_type=$(this).data("type");that.batch_file_manage(batch_type),ev.stopPropagation(),ev.preventDefault()})),$(".file_nav_view").on("click",".file_all_paste",(function(){that.paste_file_or_dir()})),$(".file_list_header").on("click",".file_name,.file_size,.file_mtime,.file_accept,.file_user",(function(e){var _tid=$(this).attr("data-tid"),_reverse=$(this).find(".icon_sort").hasClass("active"),_active=$(this).hasClass("active");return!$(this).find(".icon_sort").hasClass("active")&&$(this).hasClass("active")?$(this).find(".icon_sort").addClass("active"):$(this).find(".icon_sort").removeClass("active"),$(this).addClass("active").siblings().removeClass("active").find(".icon_sort").removeClass("active").empty(),$(this).find(".icon_sort").html('<i class="iconfont icon-xiala"></i>'),_active||(_reverse=!0),bt.set_cookie("files_sort",_tid),bt.set_cookie("name_reverse",_reverse?"True":"False"),that.reader_file_list({reverse:_reverse?"True":"False",sort:_tid}),!1})),$(".file_list_header .file_th").each((function(index,item){var files_sort=bt.get_cookie("files_sort"),name_reverse=bt.get_cookie("name_reverse");$(this).attr("data-tid")===files_sort&&($(this).addClass("active").siblings().removeClass("active").find(".icon_sort").removeClass("active").empty(),$(this).find(".icon_sort").html('<i class="iconfont icon-xiala"></i>'),"False"===name_reverse&&$(this).find(".icon_sort").addClass("active"))})),$(".file_list_header .file_check").on("click",(function(e){var checkbox;switch(parseInt($(this).data("checkbox"))){case 0:$(this).addClass("active").removeClass("active_2").data("checkbox",1),$(".file_list_content .file_tr").addClass("active").removeClass("active_2"),$(".nav_group.multi").removeClass("hide"),that.file_table_arry=that.file_list.slice();break;case 2:$(this).addClass("active").removeClass("active_2").data("checkbox",1),$(".file_list_content .file_tr").addClass("active"),$(".nav_group.multi").removeClass("hide"),that.file_table_arry=that.file_list.slice();break;case 1:$(this).removeClass("active active_2").data("checkbox",0),$(".file_list_content .file_tr").removeClass("active"),$(".nav_group.multi").addClass("hide"),that.file_table_arry=[]}that.calculate_table_active()})),$(".file_list_content").on("click",".file_checkbox",(function(e){var _tr=$(this).parents(".file_tr"),index=_tr.data("index"),filename=_tr.data("filename");_tr.hasClass("active")?(_tr.removeClass("active"),that.remove_check_file(that.file_table_arry,"filename",filename)):(_tr.addClass("active"),_tr.attr("data-filename",that.file_list[index].filename),that.file_table_arry.push(that.file_list[index])),that.calculate_table_active(),e.stopPropagation()})),$(".file_list_content").scroll((function(e){$(this).scrollTop()==$(this)[0].scrollHeight-$(this)[0].clientHeight?($(this).prev().css("opacity",1),$(this).next().css("opacity",0)):$(this).scrollTop()>0?$(this).prev().css("opacity",1):0==$(this).scrollTop()&&($(this).prev().css("opacity",0),$(this).next().css("opacity",1))})),$(".file_table_view .file_list_content").on("click",".file_tr",(function(e){if($(e.target).hasClass("foo_menu_title"))return!0;$(this).addClass("active").siblings().removeClass("active"),that.file_table_arry=[that.file_list[$(this).data("index")]],that.calculate_table_active(),navigator.userAgent.match(/(iPhone|iPod|Android|ios)/i)&&(that.render_file_groud_menu(e,this),$(".selection_right_menu").removeAttr("style"),$(this).addClass("app_menu_operation").find(".app_menu_group").remove(),$(this).append('<div class="app_menu_group"><ul></ul></div>'),$(this).siblings().removeClass("app_menu_operation").find(".app_menu_group").remove(),that.reader_menu_list({el:$(".app_menu_group"),ev:e,data:that.file_list[$(this).data("index")],list:that.file_selection_operating})),e.stopPropagation(),e.preventDefault()})),$(".file_table_view .file_list_content").on("click",".file_name .iconfont",(function(e){var file_tr,index=$(this).parents(".file_tr").data("index"),data=that.file_list[index];data.index=index,$(this).hasClass("icon-share1")&&that.info_file_share(data),$(this).hasClass("icon-favorites")&&that.cancel_file_favorites(data),e.stopPropagation()})),$(".file_table_view .file_list_content").on("dblclick",".file_tr",(function(e){var index=$(this).data("index"),data=that.file_list[index];if($(e.target).hasClass("file_check")||$(e.target).parents(".foo_menu").length>0||that.is_editor)return!1;if("dir"==data.type){if("Recycle_bin"==data.filename)return that.recycle_bin_view();that.reader_file_list({path:that.file_path+"/"+data.filename,is_operating:!0})}else switch(data.open_type){case"text":openEditorView(0,data.path);break;case"video":that.open_video_play(data);break;case"images":that.open_images_preview(data)}e.stopPropagation(),e.preventDefault()})),$(".file_table_view .file_list_content").on("click",".file_title i",(function(e){var file_tr,index=$(this).parents(".file_tr").data("index"),data=that.file_list[index];if("dir"==data.type){if("Recycle_bin"==data.filename)return that.recycle_bin_view();that.reader_file_list({path:that.file_path+"/"+data.filename,is_operating:!0})}e.stopPropagation(),e.preventDefault()})),$(".file_list_content").on("contextmenu",(function(ev){return"createArea"==$(ev.target).attr("name")||"rename_file_input"==$(ev.target).attr("name")})),$(".selection_right_menu").on("contextmenu",(function(ev){return!1})),$(".file_list_content").on("mousedown",".file_tr",(function(ev){if(1===ev.which&&$(ev.target).hasClass("foo_menu_title"))that.render_file_groud_menu(ev,this),$(ev.target).parent().addClass("foo_menu_click"),$(this).siblings().find(".foo_menu").removeClass("foo_menu_click"),$(this).addClass("active selected").siblings().removeClass("active selected");else{if(3!==ev.which||that.is_editor)return!0;that.file_table_arry.length>1?that.render_files_multi_menu(ev):(that.render_file_groud_menu(ev,this),$(".content_right_menu").removeAttr("style"),$(this).addClass("active selected").siblings().removeClass("active selected"))}ev.stopPropagation(),ev.preventDefault()})),$(".filePage").on("change",".showRow",(function(){var val=$(this).val();bt.set_storage("local","showRow",val),that.reader_file_list({showRow:val,p:1,is_operating:!1})})),$(".filePage").on("click","div:nth-child(2) a",(function(e){var num=$(this).attr("href").match(/p=([0-9]+)$/)[1];that.reader_file_list({path:that.path,p:num}),e.stopPropagation(),e.preventDefault()})),$(".file_list_content").on("click",".folder_size",(function(e){var data=that.file_list[$(this).parents(".file_tr").data("index")],_this=this;that.get_file_size({path:data.path},(function(res){$(_this).text(bt.format_size(res.size))})),e.stopPropagation(),e.preventDefault()})),$(".filePage").on("click","#file_all_size",(function(e){that.get_dir_size({path:that.file_path})})),$(".file_list_content").on("mousedown",(function(ev){if($(ev.target).hasClass("file_checkbox")||$(ev.target).hasClass("file_check")||"i"==ev.target.localName||$(ev.target).parents(".app_menu_group").length>0||$(ev.target).hasClass("createModel")||$(ev.target).hasClass("editr_tr")||"createArea"==$(ev.target).attr("name")||"rename_file_input"==$(ev.target).attr("name")||that.is_editor)return!0;if(3==ev.which&&!that.is_editor)return $(".selection_right_menu").removeAttr("style"),that.render_file_all_menu(ev,this),!0;$(".file_list_content").bind("mousewheel",(function(){return!1}));var container=$(this),scroll_h=0,con_t=container.offset().top,con_l=container.offset().left,startPos={top:ev.clientY-$(this).offset().top,left:ev.clientX-$(this).offset().left};$(document).unbind("mousemove").mousemove((function(ev){var endPos={top:ev.clientY-con_t>0&&ev.clientY-con_t<container.height()?ev.clientY-con_t:ev.clientY-(con_t+container.height())>1?container.height():0,left:ev.clientX-con_l>0&&ev.clientX-con_l<container.width()?ev.clientX-con_l:ev.clientX-(con_l+container.width())>1?container.width():0},fixedPoint={top:endPos.top>startPos.top?startPos.top:endPos.top,left:endPos.left>startPos.left?startPos.left:endPos.left};"list"==bt.get_cookie("rank")&&(fixedPoint.top=fixedPoint.top+40);var w=Math.min(Math.abs(endPos.left-startPos.left),con_l+container.width()-fixedPoint.left),h=Math.min(Math.abs(endPos.top-startPos.top),con_t+container.height()-fixedPoint.top);if(ev.clientY-con_t<0){var beyond_t=Math.abs(ev.clientY-con_t);container.scrollTop(container.scrollTop()-beyond_t),0!=container.scrollTop()&&(scroll_h+=beyond_t),h+=scroll_h}if(ev.clientY-(con_t+container.height())>1){var beyond_b=ev.clientY-(con_t+container.height());container.scrollTop(container.scrollTop()+beyond_b),container[0].scrollHeight-container[0].scrollTop!==container[0].clientHeight&&(scroll_h+=beyond_b),h+=scroll_h,fixedPoint.top=fixedPoint.top-scroll_h}that.enter_files_box().show().css({left:fixedPoint.left+"px",top:fixedPoint.top+"px",width:w+"px",height:h+"px"});var box_offset_top=that.enter_files_box().offset().top,box_offset_left=that.enter_files_box().offset().left,box_offset_w=that.enter_files_box().offset().left+that.enter_files_box().width(),box_offset_h=that.enter_files_box().offset().top+that.enter_files_box().height();$(container).find(".file_tr").each((function(i,item){var offset_top=$(item).offset().top,offset_left=$(item).offset().left,offset_h=$(item).offset().top+$(item).height(),offset_w=$(item).offset().left+$(item).width();"icon"==bt.get_cookie("rank")?offset_w>=box_offset_left&&offset_left<=box_offset_w&&offset_h>=box_offset_top&&offset_top<=box_offset_h?$(item).addClass("active"):$(item).removeClass("active"):offset_w>=box_offset_left&&offset_h>=box_offset_top&&offset_top<=box_offset_h?$(item).addClass("active"):$(item).removeClass("active")}))})),$(document).on("mouseup",(function(){var _move_array=[],box_offset_top=that.enter_files_box().offset().top,box_offset_left=that.enter_files_box().offset().left,box_offset_w=that.enter_files_box().offset().left+that.enter_files_box().width(),box_offset_h=that.enter_files_box().offset().top+that.enter_files_box().height();$(container).find(".file_tr").each((function(i,item){var offset_top=$(item).offset().top,offset_left=$(item).offset().left,offset_h=$(item).offset().top+$(item).height(),offset_w=$(item).offset().left+$(item).width();"icon"==bt.get_cookie("rank")?offset_w>=box_offset_left&&offset_left<=box_offset_w&&offset_h>=box_offset_top&&offset_top<=box_offset_h&&_move_array.push($(item).data("index")):offset_w>=box_offset_left&&offset_h>=box_offset_top&&offset_top<=box_offset_h&&_move_array.push($(item).data("index"))})),that.render_file_selected(_move_array),that.enter_files_box().remove(),$(".file_list_content").unbind("mousewheel")})),ev.stopPropagation(),ev.preventDefault()})),$(".file_list_header").on("mousedown",".file_width_resize",(function(ev){if(3==ev.which)return!1;var th=$(this),Minus_v=$(this).prev().offset().left,_header,maxlen=0;maxlen=$(".file_list_header").innerWidth()-$(".file_main_title").data,$(document).unbind("mousemove").mousemove((function(ev){var thatPos=ev.clientX-Minus_v;that.set_style_width(th.prev().data("tid"),thatPos)})),$(document).one("mouseup",th,(function(ev){$(document).unbind("mousemove")})),ev.stopPropagation(),ev.preventDefault()})),$(".cut_view_model").on("click",(function(){var type=$(this).data("type");$(".file_table_view").addClass("icon"==type?"icon_view":"list_view").removeClass("icon"!=type?"icon_view":"list_view").scrollLeft(0),bt.set_cookie("rank",type),$(this).addClass("active").siblings().removeClass("active"),that.set_file_table_width()}))},enter_files_box:function(){return 0==$("#web_mouseDrag").length&&$("<div></div>",{id:"web_mouseDrag",style:["position:absolute; top:0; left:0;","border:1px solid #072246; background-color: #cce8ff;","filter:Alpha(Opacity=15); opacity:0.15;","overflow:hidden;display:none;z-index:9;"].join("")}).appendTo(".file_table_view"),$("#web_mouseDrag")},clear_table_active:function(){this.file_table_arry=[],$(".file_list_header .file_check").removeClass("active active_2"),$(".file_list_content .file_tr").removeClass("active app_menu_operation"),$(".file_list_content .file_tr .file_ps .foo_menu").removeClass("foo_menu_click"),$(".app_menu_group").remove()},calculate_table_active:function(){var that=this,header_check=$(".file_list_header .file_check");0==this.file_table_arry.length?header_check.removeClass("active active_2").data("checkbox",0):this.file_table_arry.length==this.file_list.length?header_check.addClass("active").removeClass("active_2").data("checkbox",1):header_check.addClass("active_2").removeClass("active").data("checkbox",2),this.file_table_arry.length>0?($(document).unbind("keydown").on("keydown",(function(e){var keyCode=e.keyCode,tagName=e.target.localName.toLowerCase();if("input"==tagName||"textarea"==tagName)return!0;e.ctrlKey&&67==keyCode&&(1==that.file_table_arry.length?(that.file_groud_event($.extend(that.file_table_arry[0],{open:"copy"})),$(".file_all_paste").removeClass("hide")):that.file_table_arry.length>1&&that.batch_file_manage("copy")),e.ctrlKey&&88==keyCode&&(1==that.file_table_arry.length?(that.file_groud_event($.extend(that.file_table_arry[0],{open:"shear"})),$(".file_all_paste").removeClass("hide")):that.file_table_arry.length>1&&that.batch_file_manage("shear"))})),this.file_table_arry.length>1?$(".nav_group.multi").removeClass("hide"):$(".nav_group.multi").addClass("hide")):($(".nav_group.multi").addClass("hide"),$(document).unbind("keydown")),$(".selection_right_menu,.file_path_input .file_dir_item .nav_down_list").removeAttr("style"),that.set_menu_line_view_resize()},set_dir_view_resize:function(){var file_path_input=$(".file_path_input"),file_dir_view=$(".file_path_input .file_dir_view"),_path_width=file_dir_view.attr("data-width"),file_item_hide=null;if(_path_width?parseInt(_path_width):(_path_width=file_dir_view.width(),file_dir_view.attr("data-width",_path_width)),file_dir_view.width()-_path_width<90){var width=0;$($(".file_path_input .file_dir_view .file_dir_item").toArray().reverse()).each((function(){var item_width=0;$(this).attr("data-width")?item_width=parseInt($(this).attr("data-width")):($(this).attr("data-width",$(this).width()),item_width=$(this).width()),width+=item_width,file_path_input.width()-width<=90?$(this).addClass("hide"):$(this).removeClass("hide")}))}var file_item_hide=file_dir_view.children(".file_dir_item.hide").clone(!0);0==file_dir_view.children(".file_dir_item.hide").length?file_path_input.removeClass("active").find(".file_dir_omit").addClass("hide"):(file_item_hide.each((function(){0==$(this).find(".glyphicon-hdd").length&&$(this).find(".file_dir").before('<span class="file_dir_icon"></span>')})),file_path_input.addClass("active").find(".file_dir_omit").removeClass("hide"),file_path_input.find(".file_dir_omit .nav_down_list").empty().append(file_item_hide),file_path_input.find(".file_dir_omit .nav_down_list .file_dir_item").removeClass("hide"))},set_menu_line_view_resize:function(){var menu_width=$(".file_nav_view").width(),disk_list_width=0,batch_list_width=0,_width=0,disk_list=$(".mount_disk_list"),batch_list=$(".nav_group.multi");disk_list.attr("data-width")||disk_list.attr("data-width",disk_list.innerWidth()),batch_list.attr("data-width")||0==batch_list.innerWidth()||-1==batch_list.innerWidth()||batch_list.attr("data-width",batch_list.innerWidth()),disk_list_width=parseInt(disk_list.attr("data-width")),batch_list_width=parseInt(batch_list.attr("data-width")),$(".file_nav_view>.nav_group").not(".mount_disk_list").each((function(){_width+=$(this).innerWidth()})),menu_width-(_width+=$(".menu-header-foot").innerWidth())<disk_list_width+5?$(".nav_group.mount_disk_list").addClass("thezoom").find(".disk_title_group_btn").removeClass("hide"):$(".nav_group.mount_disk_list,.nav_group.multi").removeClass("thezoom")},set_file_forward:function(){var that=this,forward_path=$(".forward_path span");1==this.file_operating.length?forward_path.addClass("active"):this.file_pointer==this.file_operating.length-1?(forward_path.eq(0).removeClass("active"),forward_path.eq(1).addClass("active")):0==this.file_pointer?(forward_path.eq(0).addClass("active"),forward_path.eq(1).removeClass("active")):forward_path.removeClass("active")},set_file_view:function(){var file_list_content=$(".file_list_content"),height=this.area[1]-$(".file_table_view")[0].offsetTop-170;$(".file_bodys").height(this.area[1]-100),50*this.file_list.length>height?(file_list_content.attr("data-height",file_list_content.data("height")||file_list_content.height()).height(height).css("overflow","auto"),$(".file_shadow_bottom").css("opacity",1)):(file_list_content.height(height).css("overflow","auto"),$(".file_shadow_top,.file_shadow_bottom").css("opacity",0))},open_share_view:function(){var that=this;layer.open({type:1,shift:5,closeBtn:2,area:["850px","580px"],title:"分享列表",content:'<div class="divtable mtb10 download_table" style="padding:5px 10px;">                    <table class="table table-hover" id="download_url">                        <thead><tr><th width="230px">分享名称</th><th width="300px">文件地址</th><th>过期时间</th><th style="text-align:right;width:120px;">操作</th></tr></thead>                        <tbody class="download_url_list"></tbody>                    </table>                    <div class="page download_url_page"></div>            </div>',success:function(){that.render_share_list(),$(".download_url_list").on("click",".info_down",(function(){var indexs=$(this).attr("data-index");that.file_share_view(that.file_share_list[indexs],"list")})),$(".download_table .download_url_page").on("click","a",(function(e){var _href=$(this).attr("href").match(/p=([0-9]+)$/)[1];that.render_share_list({p:_href}),e.stopPropagation(),e.preventDefault()}))}})},render_share_list:function(param){var that=this,_list="";void 0===param&&(param={p:1}),this.$http("get_download_url_list",param,(function(res){that.file_share_list=res.data,res.data.length>0?$.each(res.data,(function(index,item){_list+='<tr><td><span style="width:230px;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;display: inline-block;" title="'+item.ps+'">'+item.ps+'</span></td><td><span style="width:300px;white-space: nowrap;overflow:hidden;text-overflow: ellipsis;display: inline-block;" title="'+item.filename+'">'+item.filename+"</span></td><td><span>"+bt.format_data(item.expire)+'</span></td><td style="text-align:right;"><a href="javascript:;" class="btlink info_down" data-id="'+item.id+'" data-index="'+index+'">详情</a>&nbsp;|&nbsp;<a href="javascript:;" class="btlink del_down" data-id="'+item.id+'" data-index="'+index+'" data-ps="'+item.ps+'">关闭</a></td></tr>'})):_list='<tr><td colspan="4">暂无分享数据</td></tr>',$(".download_url_list").html(_list),$(".download_url_page").html(res.page),$(".download_table").on("click",".del_down",(function(){var id=$(this).attr("data-id"),_ps=$(this).attr("data-ps");that.remove_download_url({id:id,fileName:_ps},(function(res){res.status&&that.render_share_list(param),layer.msg(res.msg,{icon:res.status?1:2})}))}))}))},remove_check_file:function(arry,key,value){for(var len=arry.length;len--;)arry[len][key]==value&&arry.splice(len,1)},open_download_view:function(){var that=this;that.reader_form_line({url:"DownloadFile",beforeSend:function(data){return{url:data.url,path:data.path,filename:data.filename}},overall:{width:"310px"},data:[{label:"URL地址:",name:"url",placeholder:"URL地址",value:"http://",eventType:["input","focus"],input:function(){var value,url_list=$(this).val().split("/");$('[name="filename"]').val(url_list[url_list.length-1])}},{label:"下载到:",name:"path",placeholder:"下载到",value:that.file_path},{label:"文件名:",name:"filename",placeholder:"保存文件名",value:"",eventType:"enter",enter:function(){$(".download_file_view .layui-layer-btn0").click()}}]},(function(form,html){var loadT=bt.open({type:1,title:"下载文件",area:"500px",shadeClose:!1,skin:"download_file_view",content:html[0].outerHTML,btn:["确认","关闭"],success:function(){form.setEvent()},yes:function(indexo,layero){var ress=form.getVal();if(!bt.check_url(ress.url))return layer.msg("请输入有效的url地址..",{icon:2}),!1;form.submitForm((function(res){that.render_present_task_list(),layer.msg(res.msg,{icon:res.status?1:2}),loadT.close()}))}})}))},set_style_width:function(type,width){var _content=bt.get_storage("session","formHeader")||$("#file_list_info").html(),_html="",_reg=new RegExp("\\.file_"+type+"\\s?\\{width\\s?\\:\\s?(\\w+)\\s\\!important;\\}","g"),_defined_config={name:150,type:80,size:80,mtime:150,accept:80,user:80,ps:150};_html=_content.replace(_reg,(function(match,$1,$2,$3){return".file_"+type+"{width:"+(width<80?_defined_config[type]+"px":width+"px")+" !important;}"})),$("#file_list_info").html(_html),bt.set_storage("session","formHeader",_html),this.set_file_table_width()},set_file_table_width:function(){var _css=bt.get_storage("session","formHeader")||$("#file_list_info").html(),_html="",mainWidth=0,_reg=new RegExp("\\.file_table_view\\.list_view\\s\\.file_list_content\\s\\.file_tr{width\\:(\\w+);}","g"),_boxReg=new RegExp("\\.file_table_view\\.list_view\\s\\.file_list_content{width\\:(\\w+);}","g"),_header=$(".file_list_header").innerWidth(),boxWidth=$(".file_table_view.list_view").innerWidth(),containerWidth="";$(".file_main_title .file_th").each((function(){mainWidth+=$(this).innerWidth()})),$(".file_main_title").attr("data-width",mainWidth),$(".file_list_header").css("width",mainWidth+10),containerWidth=mainWidth+20+"px",boxWidth>=mainWidth+5&&(containerWidth="auto",$(".file_list_header").css("width",""),$(".file_main_title .file_width_resize:last-child").css("display","block")),_html=_css.replace(_boxReg,".file_table_view.list_view .file_list_content{width:"+containerWidth+";}").replace(_reg,".file_table_view.list_view .file_list_content .file_tr{width:"+(mainWidth+2)+"px;}"),$("#file_list_info").html(_html)},render_path_list:function(callback){var that=this,html='<div class="file_dir_omit hide" title="展开已隐藏的目录"><span></span><i class="iconfont icon-zhixiang-zuo"></i><div class="nav_down_list"></div></div>',path_before="",dir_list=this.file_path.split("/").splice(1),first_dir=this.file_path.split("/")[0];"Windows"===bt.os?(0==dir_list.length&&(dir_list=[]),dir_list.unshift('<span class="glyphicon glyphicon-hdd"></span><span class="ml5">本地磁盘('+first_dir+")</span>")):("/"==this.file_path&&(dir_list=[]),dir_list.unshift("根目录"));for(var i=0;i<dir_list.length;i++)path_before+="/"+dir_list[i],0==i&&(path_before="/"),html+='<div class="file_dir_item">                        <span class="file_dir" title="'+path_before.replace("//","/")+'">'+dir_list[i]+'</span>                        <i class="iconfont icon-arrow-right"></i>                        <ul class="nav_down_list">                            <li data-path="*"><span>加载中</span></li>                        </ul>                    </div>';$(".path_input").val("").attr("data-path",this.file_path);var file_dir_view=$(".file_path_input .file_dir_view");file_dir_view.html(html),file_dir_view.attr("data-width",file_dir_view.width()),this.set_dir_view_resize.delay(this,100)},render_path_down_list:function(el,path,callback){var that=this,_html="",next_path=$(el).parent().next().find(".file_dir").attr("title");this.get_dir_list({path:path},(function(res){$.each(that.data_reconstruction(res.DIR),(function(index,item){var _path=("/"!=path?path:"")+"/"+item.filename;_html+='<li data-path="'+_path+'" title="'+_path+'" class="'+(_path===next_path?"active":"")+'"><i class="file_menu_icon newly_file_icon"></i><span>'+item.filename+"</span></li>"})),$(el).html(_html)}))},reader_file_list:function(data,callback){var that=this,select_page_num="",next_path="",model=bt.get_cookie("rank"),isPaste=bt.get_storage("session","record_paste_type");"null"!=isPaste&&null!=isPaste?$(".file_nav_view .file_all_paste").removeClass("hide"):$(".file_nav_view .file_all_paste").addClass("hide"),$(".file_table_view").removeClass(".list_view,.icon_view").addClass("list"==model?"list_view":"icon_view"),$(".cut_view_model:nth-child("+("list"==model?"2":"1")+")").addClass("active").siblings().removeClass("active"),this.file_images_list=[],this.get_dir_list(data,(function(res){if(!1===res.status&&res.msg.indexOf("指定目录不存在!")>-1)return that.reader_file_list({path:"/www"});that.file_list=$.merge(that.data_reconstruction(res.DIR,"DIR"),that.data_reconstruction(res.FILES)),that.file_path=that.path_check(res.PATH),that.is_recycle=res.FILE_RECYCLE,that.file_store_list=res.STORE,bt.set_cookie("Path",that.path_check(res.PATH)),that.reader_file_list_content(that.file_list,(function(rdata){$(".path_input").attr("data-path",that.file_path),$(".file_nav_view .multi").addClass("hide"),$(".selection_right_menu").removeAttr("style"),$.each(["100","200","500","1000","2000"],(function(index,item){select_page_num+='<option value="'+item+'" '+(item==(bt.get_storage("local","showRow")||that.file_page_num)?"selected":"")+">"+item+"</option>"}));var page=$(res.PAGE);page.append('<span class="Pcount-item">每页<select class="showRow">'+select_page_num+"</select>条</span>"),$(".filePage").html('<div class="page_num">共'+rdata.is_dir_num+"个目录，"+(that.file_list.length-rdata.is_dir_num)+'个文件，文件大小:<a href="javascript:;" class="btlink" id="file_all_size">点击获取</a></div>'+page[0].outerHTML),data.is_operating&&that.file_operating[that.file_pointer]!=res.PATH&&(void 0!==(next_path=that.file_operating[that.file_pointer+1])&&next_path!=res.PATH&&that.file_operating.splice(that.file_pointer+1),that.file_operating.push(res.PATH),that.file_pointer=that.file_operating.length-1),that.render_path_list(),that.set_file_forward(),that.set_file_table_width(),that.render_favorites_list(),that.set_file_view(),callback&&callback(res)}))}))},data_reconstruction:function(data,type,callback){if(data.length<1)return[];var _array=[];return $.each(data,(function(index,item){var itemD=item.split(";"),fileMsg="",fileN=itemD[0].split("."),extName=fileN[fileN.length-1];switch(itemD[0]){case".user.ini":fileMsg="PS: PHP用户配置文件(防跨站)!";break;case".htaccess":fileMsg="PS: Apache用户配置文件(伪静态)";break;case"swap":fileMsg="PS: 宝塔默认设置的SWAP交换分区文件"}-1!=itemD[0].indexOf("Recycle_bin")&&(fileMsg="PS: 回收站目录,勿动!"),-1!=itemD[0].indexOf(".upload.tmp")&&(fileMsg="PS: 宝塔文件上传临时文件,重新上传从断点续传,可删除"),_array.push({caret:"1"==itemD[8],down_id:parseInt(itemD[9]),ext:"DIR"==type?"":extName.toLowerCase(),filename:itemD[0],mtime:itemD[2],ps:fileMsg||itemD[10]||"",size:itemD[1],type:"DIR"==type?"dir":"file",user:itemD[3],root_level:itemD[4]})})),_array},render_file_selected:function(_array){$(document).unbind("mouseup").unbind("mousemove");var that=this,tmp=[];that.clear_table_active(),$.each(_array,(function(index,item){-1==tmp.indexOf(item)&&tmp.push(item)})),$.each(tmp,(function(ind,items){$(".file_list_content .file_tr").eq(items).addClass("active"),that.file_table_arry.push(that.file_list[items])})),that.calculate_table_active()},render_favorites_list:function(){var html="";this.file_store_list.length>0?($.each(this.file_store_list,(function(index,item){html+='<li title="'+item.name+'" data-path="'+item.path+'" data-type="'+item.type+'"><i class="'+("file"==item.type?"file_new_icon":"file_menu_icon create_file_icon")+'"></i><span>'+item.name+"</span></li>"})),html+='<li data-manage="favorites" onclick="bt_file.set_favorites_manage()"><span class="iconfont icon-shezhi1"></span><span>管理</span></li>'):html='<li data-null style="width: 150px;"><i></i><span>（空）</span></li>',$(".favorites_file_path .nav_down_list").html(html)},set_favorites_manage:function(){var that=this;layer.open({type:1,title:"管理收藏夹",area:["850px","580px"],closeBtn:2,shift:5,shadeClose:!1,content:"<div class='stroe_tab_list bt-table pd15'>                    <div class='divtable' style='height:420px'>                    <table class='table table-hover'>                        <thead><tr><th>路径</th><th style='text-align:right'>操作</th></tr></thead>                        <tbody class='favorites_body'></tbody>                    </table></div></div>",success:function(layers){that.render_favorites_type_list(),setTimeout((function(){$(layers).css("top",($(window).height()-$(layers).height())/2)}),50)},cancel:function(){that.reader_file_list({path:that.file_path})}})},render_favorites_type_list:function(){var _detail="";this.$http("get_files_store",(function(rdata){rdata.length>0?$.each(rdata,(function(ind,item){_detail+='<tr><td><span class="favorites_span" title="'+item.path+'">'+item.path+'</span></td><td style="text-align:right;"><a class="btlink" onclick="bt_file.del_favorites(\''+item.path+"')\">删除</a></td></tr>"})):_detail='<tr><td colspan="2">暂无收藏</td></tr>',$(".favorites_body").html(_detail),jQuery.prototype.fixedThead?$(".stroe_tab_list .divtable").fixedThead({resize:!1}):$(".stroe_tab_list .divtable").css({overflow:"auto"})}))},load_favorites_index_list:function(){var that=this;this.$http("get_files_store",(function(rdata){that.file_store_list=rdata,that.render_favorites_list()}))},del_favorites:function(path){var that=this;layer.confirm("是否确定删除路径【"+path+"】？",{title:"删除收藏夹",closeBtn:2,icon:3},(function(index){that.$http("del_files_store",{path:path},(function(res){res.status&&that.render_favorites_type_list(),layer.msg(res.msg,{icon:res.status?1:2})}))}))},reader_file_list_content:function(data,callback){var _html="",that=this,is_dir_num=0,images_num=0;$.each(data,(function(index,item){var _title=item.filename,only_id=bt.get_random(10),path=(that.file_path+"/"+item.filename).replace("//","/");that.file_list[index].only_id=only_id,_html+='<div class="file_tr" data-index="'+index+'" data-filename="'+item.filename+'" '+("icon"==bt.get_cookie("rank")?'title="'+path+"&#13;"+lan.files.file_size+":"+bt.format_size(item.size)+"&#13;"+lan.files.file_etime+":"+bt.format_data(item.mtime)+"&#13;"+lan.files.file_auth+":"+item.user+"&#13;"+lan.files.file_own+":"+item.root_level+'"':"")+'><div class="file_td file_checkbox"><div class="file_check"></div></div><div class="file_td file_name"><div class="file_ico_type"><i class="file_icon '+("dir"==item.type?"file_folder":(""==item.ext?"":"file_"+item.ext).replace("//","/"))+'"></i></div><span class="file_title file_'+item.type+'_status" '+("icon"==bt.get_cookie("rank")?"":'title="'+path+'"')+"><i>"+item.filename+"</i></span>"+(item.caret?'<span class="iconfont icon-favorites" style="'+(0!=item.down_id?"right:30px":"")+'" title="文件已收藏，点击取消"></span>':"")+(0!=item.down_id?'<span class="iconfont icon-share1" title="文件已分享，点击查看信息"></span>':"")+'</div><div class="file_td file_type hide"><span title="'+("dir"==item.type?"文件夹":that.ext_type_tips(item.ext))+'">'+("dir"==item.type?"文件夹":that.ext_type_tips(item.ext))+'</span></div><div class="file_td file_accept"><span>'+item.user+'</span></div><div class="file_td file_user"><span>'+item.root_level+'</span></div><div class="file_td file_size"><span>'+("dir"==item.type?'<a class="btlink folder_size" href="javascript:;" data-path="'+path+'">点击计算</a>':bt.format_size(item.size))+'</span></div><div class="file_td file_mtime"><span>'+bt.format_data(item.mtime)+'</span></div><div class="file_td file_ps"><span class="file_ps_title" title="'+item.ps+'">'+item.ps+'</span><div class="foo_menu"><span class="foo_menu_title">操作</span></div></div></div>',"dir"==item.type&&is_dir_num++,item.path=path,item.open_type=that.determine_file_type(item.ext),"images"==item.open_type&&(item.images_id=images_num,that.file_images_list.push(item.path),images_num++)})),$(".file_list_content").html(_html),callback&&callback({is_dir_num:is_dir_num}),that.clear_table_active()},render_file_disk_list:function(){var that=this,html="",_li="";that.get_disk_list((function(res){$.each(res,(function(index,item){html+='<div class="nav_btn" data-menu="'+item.path+'"><span class="glyphicon glyphicon-hdd"></span><span>'+("/"==item.path?"根目录":item.path)+" ("+item.size[2]+")</span></div>",_li+='<li data-disk="'+item.path+'"><i class="glyphicon glyphicon-hdd"></i><span>'+("/"==item.path?"根目录":item.path)+" ("+item.size[2]+")</span></li>"})),$(".mount_disk_list").html('<div class="disk_title_group_btn hide"><span class="disk_title_group">磁盘挂载</span><i class="iconfont icon-xiala"></i><ul class="nav_down_list">'+_li+'</ul></div><div class="file_disk_list">'+html+"</div>"),that.set_menu_line_view_resize()}))},render_file_groud_menu:function(ev,el){var that=this,index=$(el).data("index"),_openTitle="打开",data=this.file_list[index],config_group=[["open",_openTitle],["split",""],["download","下载"],["share","分享目录/文件"],["cancel_share","取消分享"],["favorites","收藏目录/文件"],["cancel_favorites","取消收藏"],["split",""],["dir_kill","目录查杀"],["authority","权限"],["split",""],["copy","复制"],["shear","剪切"],["rename","重命名"],["del","删除"],["split",""],["compress","创建压缩",[["tar_gz","tar.gz (推荐)"],["zip","zip (通用格式)"],["rar","rar (中文兼容较好)"]]],["unzip","解压",[["folad","解压到..."]]]],compression=["zip","rar","gz","war","tgz","bz2"],offsetNum=0;switch(this.determine_file_type(data.ext)){case"images":_openTitle="预览";break;case"video":_openTitle="播放";break;default:_openTitle="编辑"}config_group[0][1]="dir"==data.type?"打开":_openTitle,"dir"==data.type&&(config_group.splice(2,1),offsetNum++),"compress"==data.open_type&&(config_group.splice(0,2),offsetNum+=2),0!=data.down_id?(config_group.splice(3-offsetNum,1),offsetNum++):(config_group.splice(4-offsetNum,1),config_group[3-offsetNum][1]="dir"==data.type?"分享目录":"分享文件",offsetNum++),!1!==data.caret?(config_group.splice(5-offsetNum,1),offsetNum++):(config_group.splice(6-offsetNum,1),config_group[5-offsetNum][1]="dir"==data.type?"收藏目录":"收藏文件",offsetNum++),"php"==data.ext&&(config_group[8-offsetNum][1]="文件查杀"),"php"!=data.ext&&"dir"!=data.type&&(config_group.splice(8-offsetNum,1),offsetNum++);var num=0;$.each(compression,(function(index,item){item==data.ext&&num++})),0==num&&(config_group.splice(17-offsetNum,1),offsetNum++),this.file_selection_operating=config_group,this.reader_menu_list({el:$(".selection_right_menu"),ev:ev,data:data,list:config_group})},render_file_all_menu:function(ev,el){var that=this,config_group=[["refresh","刷新"],["split",""],["upload","上传"],["create","新建文件夹/文件",[["create_dir","新建文件夹"],["create_files","新建文件"]]],["web_shell","终端"],["split",""],["paste","粘贴"]],offsetNum=0,isPaste=bt.get_storage("session","record_paste_type");"null"!=isPaste&&null!=isPaste||(config_group.splice(5,2),offsetNum++),this.reader_menu_list({el:$(".selection_right_menu"),ev:ev,data:{},list:config_group})},render_files_multi_menu:function(ev){var that=this,config_group=[["copy","复制"],["shear","剪切"],["authority","权限"],["compress","创建压缩"],["del","删除"]],el=$(".selection_right_menu").find("ul"),el_height=el.height(),el_width=el.width(),left=ev.clientX-(this.area[0]-ev.clientX<el_width?el_width:0);el.empty(),$.each(config_group,(function(index,mitem){var $children=null,type;"split"==mitem[0]?el.append('<li class="separate"></li>'):el.append($('<li><i class="file_menu_icon '+mitem[0]+"_file_icon "+(type=mitem[0],"authority"==type?"iconfont icon-authority":"")+'"></i><span>'+mitem[1]+"</span></li>").append(null).on("click",{type:mitem[0],data:that.file_table_arry},(function(ev){$(".selection_right_menu").removeAttr("style"),that.batch_file_manage(ev.data.type),ev.stopPropagation(),ev.preventDefault()})))})),$(".selection_right_menu").css({left:left,top:ev.clientY-(this.area[1]-ev.clientY<el_height?el_height:0)}).removeClass("left_menu right_menu").addClass(this.area[0]-(left+el_width)<230?"left_menu":"right_menu"),$(document).one("click",(function(e){$(ev.currentTarget).removeClass("selected"),$(".selection_right_menu").removeAttr("style"),e.stopPropagation(),e.preventDefault()}))},reader_menu_list:function(config){var that=this,el=config.el.find("ul"),el_height=0,el_width=el.width(),left=config.ev.clientX-(this.area[0]-config.ev.clientX<el_width?el_width:0),top=0;el.empty(),$.each(config.list,(function(index,item){var $children=null,$children_list=null;"split"==item[0]?el.append('<li class="separate"></li>'):(Array.isArray(item[2])&&($children=$('<div class="file_menu_down"><span class="glyphicon glyphicon-triangle-right" aria-hidden="true"></span><ul class="set_group"></ul></div>'),$children_list=$children.find(".set_group"),$.each(item[2],(function(indexs,items){$children_list.append($('<li><i class="file_menu_icon '+items[0]+'_file_icon"></i><span>'+items[1]+"</span></li>").on("click",{type:items[0],data:config.data},(function(ev){that.file_groud_event($.extend(ev.data.data,{open:ev.data.type,index:parseInt($(config.ev.currentTarget).data("index")),element:config.ev.currentTarget,type_tips:"dir"==config.data.type?"文件夹":"文件"})),config.el.removeAttr("style"),ev.stopPropagation(),ev.preventDefault()})))}))),el.append($('<li><i class="file_menu_icon '+item[0]+"_file_icon "+function(type){switch(type){case"share":case"cancel_share":return"iconfont icon-share";case"dir_kill":return"iconfont icon-dir_kill";case"authority":return"iconfont icon-authority"}return""}(item[0])+'"></i><span>'+item[1]+"</span></li>").append($children).on("click",{type:item[0],data:config.data},(function(ev){that.file_groud_event($.extend(ev.data.data,{open:ev.data.type,index:parseInt($(config.ev.currentTarget).data("index")),element:config.ev.currentTarget,type_tips:"dir"==config.data.type?"文件夹":"文件"})),"compress"!=item[0]&&"create"!=item[0]&&config.el.removeAttr("style"),ev.stopPropagation(),ev.preventDefault()}))))})),el_height=el.innerHeight(),top=config.ev.clientY-(this.area[1]-config.ev.clientY<el_height?el_height:0),$(config.ev.target).hasClass("foo_menu_title")&&(left=this.area[0]-config.ev.clientX<el_width+54?config.ev.clientX-el_width-config.ev.offsetX-13:config.ev.clientX-config.ev.offsetX+41,top=this.area[1]-config.ev.clientY<el_height+26?config.ev.clientY-el_height-config.ev.offsetY+10:config.ev.clientY-config.ev.offsetY+10),config.el.css({left:left+10,top:top}).removeClass("left_menu right_menu").addClass(this.area[0]-(left+el_width)<230?"left_menu":"right_menu")},ext_type_tips:function(ext){var config={ai:"Adobe Illustrator格式图形",apk:"安卓安装包",asp:"动态网页文件",bat:"批处理文件",bin:"二进制文件",bas:"BASIC源文件",bak:"备份文件",css:"CSS样式表",cad:"备份文件",cxx:"C++源代码文件",crt:"认证文件",cpp:"C++代码文件",conf:"配置文件",dat:"数据文件",der:"认证文件",doc:"Microsoft Office Word 97-2003 文档",docx:"Microsoft Office Word 2007 文档",exe:"程序应用",gif:"图形文件",go:"Go语言源文件",htm:"超文本文档",html:"超文本文档",ico:"图形文件",java:"Java源文件",access:"数据库文件",jsp:"HTML网页",jpe:"图形文件",jpeg:"图形文件",jpg:"图形文件",log:"日志文件",link:"快捷方式文件",js:"Javascript源文件",mdb:"Microsoft Access数据库",mp3:"音频文件",ape:"CloudMusic.ape",mp4:"视频文件",avi:"视频文件",mkv:"视频文件",rm:"视频文件",mov:"视频文件",mpeg:"视频文件",mpg:"视频文件",rmvb:"视频文件",webm:"视频文件",wma:"视频文件",wmv:"视频文件",swf:"Shockwave Flash Object",mng:"多映像网络图形",msi:"Windows Installe安装文件包",png:"图形文件",py:"Python源代码",pyc:"Python字节码文件",pdf:"文档格式文件",ppt:"Microsoft Powerpoint 97-2003 幻灯片演示文稿",pptx:"Microsoft Powerpoint2007 幻灯片演示文稿",psd:"Adobe photoshop位图文件",pl:"Perl脚本语言",rar:"RAR压缩文件",reg:"注册表文件",sys:"系统文件",sql:"数据库文件",sh:"Shell脚本文件",txt:"文本格式",vb:"Visual Basic的一种宏语言",xml:"扩展标记语言",xls:"Microsoft Office Excel 97-2003 工作表",xlsx:"Microsoft Office Excel 2007 工作表",gz:"压缩文件",zip:"ZIP压缩文件",z:"","7z":"7Z压缩文件",json:"JSON文本",php:"PHP源文件",mht:"MHTML文档",bmp:"BMP图片文件",webp:"WEBP图片文件",cdr:"CDR文件"};return void 0!==config[ext]?config[ext]:"未知文件"},determine_file_type:function(ext,type){var config={images:["jpg","jpeg","png","bmp","gif","tiff","ico","JPG","webp"],compress:["zip","rar","gz","war","tgz"],video:["mp4","mp3","mpeg","mpg","mov","avi","webm","mkv","mkv","mp3","rmvb","wma","wmv"],ont_text:["iso","xlsx","xls","doc","docx","tiff","exe","so","7z","bz","dmg","apk","pptx","ppt","xlsb","pdf"]},returnVal=!1;if(null!=type)if("text"==type)$.each(config,(function(key,item){$.each(item,(function(index,items){if(items==ext)return returnVal=!0,!1}))})),returnVal=!returnVal;else{if(void 0===config[type])return!1;$.each(config[type],(function(key,item){if(item==ext)return returnVal=!0,!1}))}else $.each(config,(function(key,item){$.each(item,(function(index,items){if(items==ext)return returnVal=key,!1}))})),"boolean"==typeof returnVal&&(returnVal="text");return returnVal},file_groud_event:function(data){var that=this;switch(data.open){case"open":if("dir"==data.type)this.reader_file_list({path:data.path});else switch(data.open_type){case"text":openEditorView(0,data.path);break;case"video":this.open_video_play(data);break;case"images":this.open_images_preview(data)}break;case"download":this.down_file_req(data);break;case"share":this.set_file_share(data);break;case"cancel_share":this.info_file_share(data);break;case"favorites":this.$http("add_files_store",{path:data.path},(function(res){res.status&&(that.file_list[data.index]=$.extend(that.file_list[data.index],{caret:!0}),that.reader_file_list_content(that.file_list),that.load_favorites_index_list()),layer.msg(res.msg,{icon:res.status?1:2})}));break;case"cancel_favorites":this.cancel_file_favorites(data);break;case"authority":this.set_file_authority(data);break;case"dir_kill":this.set_dir_kill(data);break;case"copy":this.copy_file_or_dir(data);break;case"shear":this.cut_file_or_dir(data);break;case"rename":this.rename_file_or_dir(data);break;case"compress":data.open="tar_gz",this.compress_file_or_dir(data);break;case"tar_gz":case"rar":case"zip":this.compress_file_or_dir(data);break;case"unzip":case"folad":this.unpack_file_to_path(data);break;case"refresh":$(".file_path_refresh").click();break;case"upload":this.file_drop.dialog_view();break;case"create_dir":$(".file_nav_view .create_file_or_dir li").eq(0).click();break;case"create_files":$(".file_nav_view .create_file_or_dir li").eq(1).click();break;case"del":this.del_file_or_dir(data);break;case"paste":this.paste_file_or_dir();break;case"web_shell":web_shell()}},batch_file_manage:function(stype){var that=this,_api="",_fname=[],_obj={},_path=$("");switch($.each(this.file_table_arry,(function(index,item){_fname.push(item.filename)})),stype){case"copy":case"shear":_api="SetBatchData",_obj.data=JSON.stringify(_fname),_obj.type="copy"==stype?"1":"2",_obj.path=that.file_path;break;case"del":return _obj.data=JSON.stringify(_fname),_obj.type="4",_obj.path=that.file_path,that.batch_file_delect(_obj);case"authority":return _obj.filename="批量",_obj.type="3",_obj.filelist=JSON.stringify(_fname),_obj.path=that.file_path,that.set_file_authority(_obj,!0);case"compress":var arry_f=that.file_path.split("/"),file_title=arry_f[arry_f.length-1];return _obj.filename=_fname.join(","),_obj.open="tar_gz",_obj.path=that.file_path+"/"+file_title,that.compress_file_or_dir(_obj,!0)}that.$http(_api,_obj,(function(res){res.status&&(bt.set_storage("session","record_paste_type","copy"==stype?"1":"2"),that.clear_table_active(),$(".nav_group.multi").addClass("hide"),$(".file_nav_view .file_all_paste").removeClass("hide")),layer.msg(res.msg,{icon:res.status?1:2})}))},batch_file_delect:function(obj){var that=this;this.is_recycle?layer.confirm("确认删除选中内容,删除后将移至回收站，是否继续操作?",{title:"批量删除",closeBtn:2,icon:3},(function(){that.$http("SetBatchData",obj,(function(res){res.status&&that.reader_file_list({path:that.file_path}),layer.msg(res.msg,{icon:res.status?1:2})}))})):bt.show_confirm("批量删除",'<span><i style="font-size: 15px;font-style: initial;color: red;">当前未开启回收站，批量删除后将无法恢复，是否继续删除?</i></span>',(function(){that.$http("SetBatchData",obj,(function(res){res.status&&that.reader_file_list({path:that.file_path}),layer.msg(res.msg,{icon:res.status?1:2})}))}))},batch_file_paste:function(){var that=this,_pCookie=bt.get_storage("session","record_paste_type");this.check_exists_files_req({dfile:this.file_path},(function(result){if(result.length>0){for(var tbody="",i=0;i<result.length;i++)tbody+='<tr><td><span class="exists_files_style">'+result[i].filename+"</td><td>"+ToSize(result[i].size)+"</td><td>"+getLocalTime(result[i].mtime)+"</td></tr>";var mbody;SafeMessage("即将覆盖以下文件",'<div class="divtable" style="max-height:350px;overflow:auto;"><table class="table table-hover" width="100%" border="0" cellpadding="0" cellspacing="0"><thead><th>文件名</th><th>大小</th><th>最后修改时间</th></thead>                            <tbody>'+tbody+"</tbody>                            </table></div>",(function(){that.$http("BatchPaste",{type:_pCookie,path:that.file_path},(function(rdata){rdata.status&&(bt.set_storage("session","record_paste_type",null),that.reader_file_list({path:that.file_path})),layer.msg(rdata.msg,{icon:rdata.status?1:2})}))}))}else that.$http("BatchPaste",{type:_pCookie,path:that.file_path},(function(rdata){rdata.status&&(bt.set_storage("session","record_paste_type",null),that.reader_file_list({path:that.file_path})),layer.msg(rdata.msg,{icon:rdata.status?1:2})}))}))},recycle_bin_view:function(){var that=this;layer.open({type:1,shift:5,closeBtn:2,area:["80%","606px"],title:lan.files.recycle_bin_title,content:'<div class="recycle_bin_view">                    <div class="re-head">                    <div style="margin-left: 3px;" class="ss-text">                        <em>'+lan.files.recycle_bin_on+'</em>                        <div class="ssh-item">                                <input class="btswitch btswitch-ios" id="Set_Recycle_bin" type="checkbox">                                <label class="btswitch-btn" for="Set_Recycle_bin" onclick="bt_file.Set_Recycle_bin()"></label>                        </div>                        <em style="margin-left: 20px;">'+lan.files.recycle_bin_on_db+'</em>                        <div class="ssh-item">                                <input class="btswitch btswitch-ios" id="Set_Recycle_bin_db" type="checkbox">                                <label class="btswitch-btn" for="Set_Recycle_bin_db" onclick="bt_file.Set_Recycle_bin(1)"></label>                        </div>                    </div>                    <span style="line-height: 32px; margin-left: 30px;">'+lan.files.recycle_bin_ps+'</span>                    <button style="float: right" class="btn btn-default btn-sm" onclick="bt_file.CloseRecycleBin();">'+lan.files.recycle_bin_close+'</button>                    </div>                    <div class="re-con">                        <div class="re-con-menu">                            <p class="on" data-type="1">'+lan.files.recycle_bin_type1+'</p>                            <p data-type="2">'+lan.files.recycle_bin_type2+'</p>                            <p data-type="3">'+lan.files.recycle_bin_type3+'</p>                            <p data-type="4">'+lan.files.recycle_bin_type4+'</p>                            <p data-type="5">'+lan.files.recycle_bin_type5+'</p>                            <p data-type="6">'+lan.files.recycle_bin_type6+'</p>                        </div>                        <div class="re-con-con">                            <div style="margin: 15px;" class="divtable">                                <table width="100%" class="table table-hover">                                    <thead>                                        <tr>                                            <th>'+lan.files.recycle_bin_th1+"</th>                                            <th>"+lan.files.recycle_bin_th2+"</th>                                            <th>"+lan.files.recycle_bin_th3+'</th>                                            <th width="150">'+lan.files.recycle_bin_th4+'</th>                                            <th style="text-align: right;" width="110">'+lan.files.recycle_bin_th5+'</th>                                        </tr>                                    </thead>                                    <tbody id="RecycleBody" class="list-list"></tbody>                                </table>                            </div>                        </div>                    </div>                </div>',success:function(){-1!=window.location.href.indexOf("database")?($(".re-con-menu p:last-child").addClass("on").siblings().removeClass("on"),that.render_recycle_list(6)):that.render_recycle_list(1),$(".re-con-menu").on("click","p",(function(){var _type=$(this).data("type");$(this).addClass("on").siblings().removeClass("on"),that.render_recycle_list(_type)}))}})},render_recycle_list:function(num){var that=this;this.$http("Get_Recycle_bin",(function(rdata){var body="";switch($("#Set_Recycle_bin").attr("checked",rdata.status),$("#Set_Recycle_bin_db").attr("checked",rdata.status_db),num){case 1:for(var i=0;i<rdata.dirs.length;i++){var shortwebname=rdata.dirs[i].name.replace(/'/,"\\'"),shortpath=rdata.dirs[i].dname;shortwebname.length>20&&(shortwebname=shortwebname.substring(0,20)+"..."),shortpath.length>20&&(shortpath=shortpath.substring(0,20)+"..."),body+='<tr>                                    <td><span class=\'ico ico-folder\'></span><span class="tname" title="'+rdata.dirs[i].name+'">'+shortwebname+'</span></td>                                    <td><span title="'+rdata.dirs[i].dname+'">'+shortpath+"</span></td>                                    <td>"+ToSize(rdata.dirs[i].size)+"</td>                                    <td>"+getLocalTime(rdata.dirs[i].time)+'</td>                                    <td style="text-align: right;">                                        <a class="btlink" href="javascript:;" onclick="bt_file.ReRecycleBin(\''+rdata.dirs[i].rname.replace(/'/,"\\'")+"',this)\">"+lan.files.recycle_bin_re+'</a>                                        | <a class="btlink" href="javascript:;" onclick="bt_file.DelRecycleBin(\''+rdata.dirs[i].rname.replace(/'/,"\\'")+"',this)\">"+lan.files.recycle_bin_del+"</a>                                    </td>                                </tr>"}for(var i=0;i<rdata.files.length;i++)if(-1==rdata.files[i].name.indexOf("BTDB_")){var shortwebname=rdata.files[i].name.replace(/'/,"\\'"),shortpath=rdata.files[i].dname;shortwebname.length>20&&(shortwebname=shortwebname.substring(0,20)+"..."),shortpath.length>20&&(shortpath=shortpath.substring(0,20)+"..."),body+='<tr>                                    <td><span class="ico ico-'+that.get_ext_name(rdata.files[i].name)+'"></span><span class="tname" title="'+rdata.files[i].name+'">'+shortwebname+'</span></td>                                    <td><span title="'+rdata.files[i].dname+'">'+shortpath+"</span></td>                                    <td>"+ToSize(rdata.files[i].size)+"</td>                                    <td>"+getLocalTime(rdata.files[i].time)+'</td>                                    <td style="text-align: right;">                                        <a class="btlink" href="javascript:;" onclick="bt_file.ReRecycleBin(\''+rdata.files[i].rname.replace(/'/,"\\'")+"',this)\">"+lan.files.recycle_bin_re+'</a>                                        | <a class="btlink" href="javascript:;" onclick="bt_file.DelRecycleBin(\''+rdata.files[i].rname.replace(/'/,"\\'")+"',this)\">"+lan.files.recycle_bin_del+"</a>                                    </td>                                </tr>"}else{var shortwebname=rdata.files[i].name.replace(/'/,"\\'"),shortpath=rdata.files[i].dname;shortwebname.length>20&&(shortwebname=shortwebname.substring(0,20)+"..."),shortpath.length>20&&(shortpath=shortpath.substring(0,20)+"..."),body+='<tr>                                    <td><span class="ico ico-'+that.get_ext_name(rdata.files[i].name)+'"></span><span class="tname" title="'+rdata.files[i].name+'">'+shortwebname.replace("BTDB_","")+'</span></td>                                    <td><span title="'+rdata.files[i].dname+'">mysql://'+shortpath.replace("BTDB_","")+"</span></td>                                    <td>-</td>                                    <td>"+getLocalTime(rdata.files[i].time)+'</td>                                    <td style="text-align: right;">                                        <a class="btlink" href="javascript:;" onclick="bt_file.ReRecycleBin(\''+rdata.files[i].rname.replace(/'/,"\\'")+"',this)\">"+lan.files.recycle_bin_re+'</a>                                        | <a class="btlink" href="javascript:;" onclick="bt_file.DelRecycleBin(\''+rdata.files[i].rname.replace(/'/,"\\'")+"',this)\">"+lan.files.recycle_bin_del+"</a>                                    </td>                                </tr>"}return void $("#RecycleBody").html(body);case 2:for(var i=0;i<rdata.dirs.length;i++){var shortwebname=rdata.dirs[i].name.replace(/'/,"\\'"),shortpath=rdata.dirs[i].dname;shortwebname.length>20&&(shortwebname=shortwebname.substring(0,20)+"..."),shortpath.length>20&&(shortpath=shortpath.substring(0,20)+"..."),body+='<tr>                                    <td><span class=\'ico ico-folder\'></span><span class="tname" title="'+rdata.dirs[i].name+'">'+shortwebname+'</span></td>                                    <td><span title="'+rdata.dirs[i].dname+'">'+shortpath+"</span></td>                                    <td>"+ToSize(rdata.dirs[i].size)+"</td>                                    <td>"+getLocalTime(rdata.dirs[i].time)+'</td>                                    <td style="text-align: right;">                                        <a class="btlink" href="javascript:;" onclick="bt_file.ReRecycleBin(\''+rdata.dirs[i].rname.replace(/'/,"\\'")+"',this)\">"+lan.files.recycle_bin_re+'</a>                                        | <a class="btlink" href="javascript:;" onclick="bt_file.DelRecycleBin(\''+rdata.dirs[i].rname.replace(/'/,"\\'")+"',this)\">"+lan.files.recycle_bin_del+"</a>                                    </td>                                </tr>"}return void $("#RecycleBody").html(body);case 3:for(var i=0;i<rdata.files.length;i++)if(-1==rdata.files[i].name.indexOf("BTDB_")){var shortwebname=rdata.files[i].name.replace(/'/,"\\'"),shortpath=rdata.files[i].dname;shortwebname.length>20&&(shortwebname=shortwebname.substring(0,20)+"..."),shortpath.length>20&&(shortpath=shortpath.substring(0,20)+"..."),body+='<tr>                                    <td><span class="ico ico-'+that.get_ext_name(rdata.files[i].name)+'"></span><span class="tname" title="'+rdata.files[i].name+'">'+shortwebname+'</span></td>                                    <td><span title="'+rdata.files[i].dname+'">'+shortpath+"</span></td>                                    <td>"+ToSize(rdata.files[i].size)+"</td>                                    <td>"+getLocalTime(rdata.files[i].time)+'</td>                                    <td style="text-align: right;">                                        <a class="btlink" href="javascript:;" onclick="bt_file.ReRecycleBin(\''+rdata.files[i].rname.replace(/'/,"\\'")+"',this)\">"+lan.files.recycle_bin_re+'</a>                                        | <a class="btlink" href="javascript:;" onclick="bt_file.DelRecycleBin(\''+rdata.files[i].rname.replace(/'/,"\\'")+"',this)\">"+lan.files.recycle_bin_del+"</a>                                    </td>                                </tr>"}return void $("#RecycleBody").html(body);case 4:for(var i=0;i<rdata.files.length;i++)if(ReisImage(getFileName(rdata.files[i].name))){var shortwebname=rdata.files[i].name.replace(/'/,"\\'"),shortpath=rdata.files[i].dname;shortwebname.length>20&&(shortwebname=shortwebname.substring(0,20)+"..."),shortpath.length>20&&(shortpath=shortpath.substring(0,20)+"..."),body+='<tr>                                    <td><span class="ico ico-'+that.get_ext_name(rdata.files[i].name)+'"></span><span class="tname" title="'+rdata.files[i].name+'">'+shortwebname+'</span></td>                                    <td><span title="'+rdata.files[i].dname+'">'+shortpath+"</span></td>                                    <td>"+ToSize(rdata.files[i].size)+"</td>                                    <td>"+getLocalTime(rdata.files[i].time)+'</td>                                    <td style="text-align: right;">                                        <a class="btlink" href="javascript:;" onclick="bt_file.ReRecycleBin(\''+rdata.files[i].rname.replace(/'/,"\\'")+"',this)\">"+lan.files.recycle_bin_re+'</a>                                        | <a class="btlink" href="javascript:;" onclick="bt_file.DelRecycleBin(\''+rdata.files[i].rname.replace(/'/,"\\'")+"',this)\">"+lan.files.recycle_bin_del+"</a>                                    </td>                                </tr>"}return void $("#RecycleBody").html(body);case 5:for(var i=0;i<rdata.files.length;i++)if(-1==rdata.files[i].name.indexOf("BTDB_")&&!ReisImage(getFileName(rdata.files[i].name))){var shortwebname=rdata.files[i].name.replace(/'/,"\\'"),shortpath=rdata.files[i].dname;shortwebname.length>20&&(shortwebname=shortwebname.substring(0,20)+"..."),shortpath.length>20&&(shortpath=shortpath.substring(0,20)+"..."),body+='<tr>                                    <td><span class="ico ico-'+that.get_ext_name(rdata.files[i].name)+'"></span><span class="tname" title="'+rdata.files[i].name+'">'+shortwebname+'</span></td>                                    <td><span title="'+rdata.files[i].dname+'">'+shortpath+"</span></td>                                    <td>"+ToSize(rdata.files[i].size)+"</td>                                    <td>"+getLocalTime(rdata.files[i].time)+'</td>                                    <td style="text-align: right;">                                        <a class="btlink" href="javascript:;" onclick="bt_file.ReRecycleBin(\''+rdata.files[i].rname.replace(/'/,"\\'")+"',this)\">"+lan.files.recycle_bin_re+'</a>                                        | <a class="btlink" href="javascript:;" onclick="bt_file.DelRecycleBin(\''+rdata.files[i].rname.replace(/'/,"\\'")+"',this)\">"+lan.files.recycle_bin_del+"</a>                                    </td>                                </tr>"}return void $("#RecycleBody").html(body);case 6:for(var i=0;i<rdata.files.length;i++)if(-1!=rdata.files[i].name.indexOf("BTDB_")){var shortwebname=rdata.files[i].name.replace(/'/,"\\'"),shortpath=rdata.files[i].dname;shortwebname.length>20&&(shortwebname=shortwebname.substring(0,20)+"..."),shortpath.length>20&&(shortpath=shortpath.substring(0,20)+"..."),body+='<tr>                                    <td><span class="ico ico-'+that.get_ext_name(rdata.files[i].name)+'"></span><span class="tname" title="'+rdata.files[i].name+'">'+shortwebname.replace("BTDB_","")+'</span></td>                                    <td><span title="'+rdata.files[i].dname+'">mysql://'+shortpath.replace("BTDB_","")+"</span></td>                                    <td>-</td>                                    <td>"+getLocalTime(rdata.files[i].time)+'</td>                                    <td style="text-align: right;">                                        <a class="btlink" href="javascript:;" onclick="bt_file.ReRecycleBin(\''+rdata.files[i].rname.replace(/'/,"\\'")+"',this)\">"+lan.files.recycle_bin_re+'</a>                                        | <a class="btlink" href="javascript:;" onclick="bt_file.DelRecycleBin(\''+rdata.files[i].rname.replace(/'/,"\\'")+"',this)\">"+lan.files.recycle_bin_del+"</a>                                    </td>                                </tr>"}return void $("#RecycleBody").html(body)}function getFileName(name){var text=name.split("."),n;return text=text[text.length-1]}function ReisImage(fileName){for(var exts=["jpg","jpeg","png","bmp","gif","tiff","ico"],i=0;i<exts.length;i++)if(fileName==exts[i])return!0;return!1}$("#RecycleBody").html(body)}))},Set_Recycle_bin:function(db){var loadT=layer.msg(lan.public.the,{icon:16,time:0,shade:[.3,"#000"]}),that=this,data={};1==db&&(data={db:db}),$.post("/files?action=Recycle_bin",data,(function(rdata){layer.close(loadT),rdata.status&&null==db&&(that.is_recycle=$("#Set_Recycle_bin").prop("checked")),layer.msg(rdata.msg,{icon:rdata.status?1:5})}))},ReRecycleBin:function(path,obj){layer.confirm(lan.files.recycle_bin_re_msg,{title:lan.files.recycle_bin_re_title,closeBtn:2,icon:3},(function(){var loadT=layer.msg(lan.files.recycle_bin_re_the,{icon:16,time:0,shade:[.3,"#000"]});$.post("/files?action=Re_Recycle_bin","path="+encodeURIComponent(path),(function(rdata){layer.close(loadT),layer.msg(rdata.msg,{icon:rdata.status?1:5}),$(obj).parents("tr").remove()}))}))},DelRecycleBin:function(path,obj){layer.confirm(lan.files.recycle_bin_del_msg,{title:lan.files.recycle_bin_del_title,closeBtn:2,icon:3},(function(){var loadT=layer.msg(lan.files.recycle_bin_del_the,{icon:16,time:0,shade:[.3,"#000"]});$.post("/files?action=Del_Recycle_bin","path="+encodeURIComponent(path),(function(rdata){layer.close(loadT),layer.msg(rdata.msg,{icon:rdata.status?1:5}),$(obj).parents("tr").remove()}))}))},CloseRecycleBin:function(){layer.confirm(lan.files.recycle_bin_close_msg,{title:lan.files.recycle_bin_close,closeBtn:2,icon:3},(function(){var loadT=layer.msg("<div class='myspeed'>"+lan.files.recycle_bin_close_the+"</div>",{icon:16,time:0,shade:[.3,"#000"]});setTimeout((function(){getSpeed(".myspeed")}),1e3),$.post("/files?action=Close_Recycle_bin","",(function(rdata){layer.close(loadT),layer.msg(rdata.msg,{icon:rdata.status?1:5}),$("#RecycleBody").html("")}))}))},open_images_preview:function(data){var that=this,mask=$('<div class="preview_images_mask"><div class="preview_head"><span class="preview_title">'+data.filename+'</span><span class="preview_small hidden" title="缩小显示"><span class="glyphicon glyphicon-resize-small" aria-hidden="true"></span></span><span class="preview_full" title="最大化显示"><span class="glyphicon glyphicon-resize-full" aria-hidden="true"></span></span><span class="preview_close" title="关闭图片预览视图"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></span></div><div class="preview_body"><img id="preview_images" src="/download?filename='+data.path+'" data-index="'+data.images_id+'"></div><div class="preview_toolbar"><a href="javascript:;" title="左旋转"><span class="glyphicon glyphicon-repeat reverse-repeat" aria-hidden="true"></span></a><a href="javascript:;" title="右旋转"><span class="glyphicon glyphicon-repeat" aria-hidden="true"></span></a><a href="javascript:;" title="放大视图"><span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></span></a><a href="javascript:;" title="缩小视图"><span class="glyphicon glyphicon-zoom-out" aria-hidden="true"></span></a><a href="javascript:;" title="重置视图"><span class="glyphicon glyphicon-refresh" aria-hidden="true"></span></a><a href="javascript:;" title="图片列表"><span class="glyphicon glyphicon-list" aria-hidden="true"></span></a></div><div class="preview_cut_view"><a href="javascript:;" title="上一张"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span></a><a href="javascript:;" title="下一张"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span></a></div></div>'),images_config={natural_width:0,natural_height:0,init_width:0,init_height:0,preview_width:0,preview_height:0,current_width:0,current_height:0,current_left:0,current_top:0,rotate:0,scale:1,images_mouse:!1};if($(".preview_images_mask").length>0)return $("#preview_images").attr("src","/download?filename="+data.path),!1;function auto_images_size(transition){var rotate=Math.abs(images_config.rotate/90),preview_width=rotate%2==0?images_config.preview_width:images_config.preview_height,preview_height=rotate%2==0?images_config.preview_height:images_config.preview_width,preview_images=$("#preview_images"),css_config={};images_config.init_width=images_config.natural_width,images_config.init_height=images_config.natural_height,images_config.init_width>preview_width&&(images_config.init_width=preview_width,images_config.init_height=parseFloat((preview_width/images_config.natural_width*images_config.init_height).toFixed(2))),images_config.init_height>preview_height&&(images_config.init_width=parseFloat((preview_height/images_config.natural_height*images_config.init_width).toFixed(2)),images_config.init_height=preview_height),images_config.current_width=parseFloat(images_config.init_width*images_config.scale),images_config.current_height=parseFloat(images_config.init_height*images_config.scale),images_config.current_left=parseFloat(((images_config.preview_width-images_config.current_width)/2).toFixed(2)),images_config.current_top=parseFloat(((images_config.preview_height-images_config.current_height)/2).toFixed(2)),css_config={width:images_config.current_width,height:images_config.current_height,top:images_config.current_top,left:images_config.current_left,display:"inline",transform:"rotate("+images_config.rotate+"deg)",opacity:1,transition:"all 100ms"},!1===transition&&delete css_config.transition,preview_images.css(css_config)}$("body").css("overflow","hidden").append(mask),images_config.preview_width=mask[0].clientWidth,images_config.preview_height=mask[0].clientHeight,$(".preview_body img").load((function(){var img=$(this)[0];$(this).attr("data-index")||$(this).attr("data-index",data.images_id),images_config.natural_width=img.naturalWidth,images_config.natural_height=img.naturalHeight,auto_images_size(!1)})),$(".preview_images_mask .preview_head").on("mousedown",(function(e){e=e||window.event;var drag=$(this).parent();if($("body").addClass("select"),$(this).onselectstart=$(this).ondrag=function(){return!1},!$(e.target).hasClass("preview_close")){var diffX=e.clientX-drag.offset().left,diffY=e.clientY-drag.offset().top;$(document).on("mousemove",(function(e){var left=(e=e||window.event).clientX-diffX,top=e.clientY-diffY;left<0?left=0:left>window.innerWidth-drag.width()&&(left=window.innerWidth-drag.width()),top<0?top=0:top>window.innerHeight-drag.height()&&(top=window.innerHeight-drag.height()),drag.css({left:left,top:top,margin:0})})).on("mouseup",(function(){$(this).unbind("mousemove mouseup")}))}})),$(".preview_images_mask #preview_images").on("mousedown",(function(e){e=e||window.event,$(this).onselectstart=$(this).ondrag=function(){return!1};var images=$(this),preview=$(".preview_images_mask").offset(),diffX=e.clientX-preview.left,diffY=e.clientY-preview.top;$(".preview_images_mask").on("mousemove",(function(e){var offsetX=(e=e||window.event).clientX-preview.left-diffX,offsetY=e.clientY-preview.top-diffY,rotate=Math.abs(images_config.rotate/90),preview_width=rotate%2==0?images_config.preview_width:images_config.preview_height,preview_height=rotate%2==0?images_config.preview_height:images_config.preview_width,left,top;if(images_config.current_width>preview_width){var max_left=preview_width-images_config.current_width;(left=images_config.current_left+offsetX)>0?left=0:left<max_left&&(left=max_left),images_config.current_left=left}if(images_config.current_height>preview_height){var max_top=preview_height-images_config.current_height;(top=images_config.current_top+offsetY)>0?top=0:top<max_top&&(top=max_top),images_config.current_top=top}images_config.current_height>preview_height&&images_config.current_top<=0&&images_config.current_height-preview_height<=images_config.current_top&&(images_config.current_top-=offsetY),images.css({left:images_config.current_left,top:images_config.current_top})})).on("mouseup",(function(){$(this).unbind("mousemove mouseup")})).on("dragstart",(function(){e.preventDefault()}))})).on("dragstart",(function(){return!1})),$(".preview_close").click((function(e){$(".preview_images_mask").remove()})),$(".preview_toolbar a").click((function(){var index=$(this).index(),images=$("#preview_images");switch(index){case 0:case 1:images_config.rotate=index?images_config.rotate+90:images_config.rotate-90,auto_images_size();break;case 2:case 3:if(3==images_config.scale&&2==index||.2==images_config.scale&&3==index)return layer.msg(images_config.scale>=1?"图像放大，已达到最大尺寸。":"图像缩小，已达到最小尺寸。"),!1;images_config.scale=(2==index?Math.round(10*(images_config.scale+.4)):Math.round(10*(images_config.scale-.4)))/10,auto_images_size();break;case 4:var scale_offset=images_config.rotate%360;scale_offset>=180?images_config.rotate+=360-scale_offset:images_config.rotate-=scale_offset,images_config.scale=1,auto_images_size()}})),$(".preview_full,.preview_small").click((function(){$(this).hasClass("preview_full")?($(this).addClass("hidden").prev().removeClass("hidden"),images_config.preview_width=that.area[0],images_config.preview_height=that.area[1],mask.css({width:that.area[0],height:that.area[1],top:0,left:0,margin:0}).data("type","full"),auto_images_size()):($(this).addClass("hidden").next().removeClass("hidden"),$(".preview_images_mask").removeAttr("style"),images_config.preview_width=750,images_config.preview_height=650,auto_images_size())})),$(".preview_cut_view a").click((function(){var images_src="",preview_images=$("#preview_images"),images_id=parseInt(preview_images.attr("data-index"));$(this).index()?(images_id=images_id==that.file_images_list.length-1?0:images_id+1,images_src=that.file_images_list[images_id]):(images_id=0===images_id?that.file_images_list.length-1:images_id-1,images_src=that.file_images_list[images_id]),preview_images.attr("data-index",images_id).attr("src","/download?filename="+images_src),$(".preview_title").html(that.get_path_filename(images_src))}))},open_video_play:function(data){var old_filename=data.path,imgUrl="/download?filename="+data.path,p_tmp=data.path.split("/"),path=p_tmp.slice(0,p_tmp.length-1).join("/");layer.open({type:1,closeBtn:2,title:'正在播放[<a class="btvideo-title">'+p_tmp[p_tmp.length-1]+"</a>]",area:["890px","402px"],shadeClose:!1,skin:"movie_pay",content:'<div id="btvideo"><video type="" src="'+imgUrl+'&play=true" data-filename="'+data.path+'" controls="controls" autoplay="autoplay" width="640" height="360">                        您的浏览器不支持 video 标签。                        </video></div><div class="video-list"></div>',success:function(){$.post("/files?action=get_videos",{path:path},(function(rdata){for(var video_list='<table class="table table-hover" style=""><thead style="display: none;"><tr><th style="word-break: break-all;word-wrap:break-word;width:165px;">文件名</th><th style="width:65px" style="text-align:right;">大小</th></tr></thead>',i=0;i<rdata.length;i++){var filename=path+"/"+rdata[i].name;video_list+='<tr class="'+(filename===old_filename?"video-avt":"")+'"><td style="word-break: break-all;word-wrap:break-word;width:150px" onclick="bt_file.play_file(this,\''+filename+'\')" title="文件: '+filename+"\n类型: "+rdata[i].type+'"><a>'+rdata[i].name+'</a></td><td style="font-size: 8px;text-align:right;width:65px;">'+ToSize(rdata[i].size)+"</td></tr>"}video_list+="</table>",$(".video-list").html(video_list)}))}})},play_file:function(obj,filename){if($("#btvideo video").attr("data-filename")==filename)return!1;var imgUrl,v='<video src="'+("/download?filename="+filename+"&play=true")+'" controls="controls" data-fileName="'+filename+'" autoplay="autoplay" width="640" height="360">您的浏览器不支持 video 标签。</video>';$("#btvideo").html(v);var p_tmp=filename.split("/");$(".btvideo-title").html(p_tmp[p_tmp.length-1]),$(".video-avt").removeClass("video-avt"),$(obj).parents("tr").addClass("video-avt")},copy_file_or_dir:function(data){bt.set_storage("session","record_paste",data.path),bt.set_storage("session","record_paste_type","copy"),$(".file_all_paste").removeClass("hide"),layer.msg("复制成功，请点击粘贴按钮，或Ctrl+V粘贴")},cut_file_or_dir:function(data){bt.set_storage("session","record_paste",data.path),bt.set_storage("session","record_paste_type","cut"),$(".file_all_paste").removeClass("hide"),layer.msg("剪切成功，请点击粘贴按钮，或Ctrl+V粘贴")},paste_file_or_dir:function(){var that=this,_isPaste=bt.get_storage("session","record_paste_type"),_paste=bt.get_storage("session","record_paste"),_filename="";if("null"!=_paste&&null!=_paste&&(_filename=_paste.split("/").pop()),that.file_path.indexOf(_paste)>-1)return layer.msg("您不能将“"+_filename+"”粘贴到此位置，因为项目不能粘贴到自身。",{icon:0}),!1;if("null"!=_isPaste&&null!=_isPaste)switch(_isPaste){case"cut":case"copy":this.check_exists_files_req({dfile:this.file_path,filename:_filename},(function(result){if(result.length>0){for(var tbody="",i=0;i<result.length;i++)tbody+='<tr><td><span class="exists_files_style">'+result[i].filename+"</span></td><td>"+ToSize(result[i].size)+"</td><td>"+getLocalTime(result[i].mtime)+"</td></tr>";var mbody;SafeMessage("即将覆盖以下文件",'<div class="divtable"><table class="table table-hover" width="100%" border="0" cellpadding="0" cellspacing="0"><thead><th>文件名</th><th>大小</th><th>最后修改时间</th></thead>                                        <tbody>'+tbody+"</tbody>                                        </table></div>",(function(){that.config_paste_to(_paste,_filename)}))}else that.config_paste_to(_paste,_filename)}));break;case"1":case"2":that.batch_file_paste()}},config_paste_to:function(path,_filename){var that=this,_type=bt.get_storage("session","record_paste_type");this.$http("copy"==_type?"CopyFile":"MvFile",{sfile:path,dfile:this.file_path+"/"+_filename},(function(rdata){rdata.status&&(bt.set_storage("session","record_paste",null),bt.set_storage("session","record_paste_type",null),that.reader_file_list({path:that.file_path})),layer.msg(rdata.msg,{icon:rdata.status?1:2})}))},rename_file_or_dir:function(data){var that=this;that.is_editor=!0,$(".file_list_content .file_tr:nth-child("+(data.index+1)+")").addClass("editr_tr").find(".file_title").empty().append($("icon"==bt.get_cookie("rank")?'<textarea name="rename_file_input" onfocus="this.select()">'+data.filename+"</textarea>":'<input name="rename_file_input" onfocus="this.select()" type="text" value="'+data.filename+'">')),"icon"==bt.get_cookie("rank")&&$("textarea[name=rename_file_input]").css({height:$("textarea[name=rename_file_input]")[0].scrollHeight}),$(("icon"==bt.get_cookie("rank")?"textarea":"input")+"[name=rename_file_input]").on("input",(function(){if("icon"==bt.get_cookie("rank")&&(this.style.height="auto",this.style.height=this.scrollHeight+"px"),"file"==data.type){var ext_arry=$(this).val().split("."),ext=ext_arry[ext_arry.length-1];$(this).parent().prev().find(".file_icon").removeAttr("class").addClass("file_icon file_"+ext)}})).keyup((function(e){13==e.keyCode&&$(this).blur(),e.stopPropagation(),e.preventDefault()})).blur((function(){var _val=$(this).val().replace(/[\r\n]/g,""),config={sfile:data.path,dfile:that.path_resolve(that.file_path,_val)};return data.filename==_val||""==_val?($(".file_list_content .file_tr:nth-child("+(data.index+1)+")").removeClass("editr_tr").find(".file_title").empty().append($("<i>"+data.filename+"</i>")),that.is_editor=!1,!1):that.match_unqualified_string(_val)?layer.msg('名称不能含有 /\\:*?"<>|符号',{icon:2}):(that.rename_file_req(config,(function(res){that.reader_file_list({path:that.file_path},(function(){layer.msg(res.msg,{icon:res.status?1:2})}))})),void(that.is_editor=!1))})).focus()},set_file_share:function(data){var that=this;this.loadY=bt.open({type:1,shift:5,closeBtn:2,area:"450px",title:"设置分享"+data.type_tips+"-["+data.filename+"]",btn:["生成外链","取消"],content:'<from class="bt-form" id="outer_url_form" style="padding:30px 15px;display:inline-block"><div class="line"><span class="tname">分享名称</span><div class="info-r"><input name="ps"  class="bt-input-text mr5" type="text" placeholder="分享名称不能为空" style="width:270px" value="'+data.filename+'"></div></div><div class="line"><span class="tname">有效期</span><div class="info-r"><label class="checkbox_grourd"><input type="radio" name="expire" value="24" checked><span>&nbsp;1天</span></label><label class="checkbox_grourd"><input type="radio" name="expire" value="168"><span>&nbsp;7天</span></label><label class="checkbox_grourd"><input type="radio" name="expire" value="1130800"><span>&nbsp;永久</span></label></div></div><div class="line"><span class="tname">提取码</span><div class="info-r"><input name="password" class="bt-input-text mr5" placeholder="为空则不设置提取码" type="text" style="width:220px" value=""><button type="button" id="random_paw" class="btn btn-success btn-sm btn-title">随机</button></div></div></from>',yes:function(indexs,layers){var ps=$("[name=ps]").val(),expire=$("[name=expire]:checked").val(),password=$("[name=password]").val();if(""===ps)return layer.msg("分享名称不能为空",{icon:2}),!1;that.create_download_url({filename:data.path,ps:ps,password:password,expire:expire},(function(res){if(!res.status)return layer.msg(res.msg,{icon:res.status?1:2}),!1;var rdata=res.msg;that.file_list[data.index]=$.extend(that.file_list[data.index],{down_id:rdata.id,down_info:rdata}),that.loadY.close(),that.info_file_share(data),that.reader_file_list_content(that.file_list)}))},success:function(layers,index){$("#random_paw").click((function(){$(this).prev().val(bt.get_random(6))}))}})},info_file_share:function(data){var that=this;if(void 0===data.down_info)return this.get_download_url_find({id:data.down_id},(function(res){that.file_list[data.index]=$.extend(that.file_list[data.index],{down_info:res}),that.file_share_view(that.file_list[data.index],"fonticon")})),!1;this.file_share_view(data,"fonticon")},file_share_view:function(datas,type){var data=datas;"fonticon"==type&&(data=datas.down_info);var that=this,download_url=location.origin+"/down/"+data.token;this.loadY=bt.open({type:1,shift:5,closeBtn:2,area:"550px",title:"外链分享-["+data.filename+"]",content:'<div class="bt-form pd20 pb70"><div class="line"><span class="tname">分享名称</span><div class="info-r"><input readonly class="bt-input-text mr5" type="text" style="width:365px" value="'+data.ps+'"></div></div><div class="line external_link"><span class="tname">分享外链</span><div class="info-r"><input readonly class="bt-input-text mr5" type="text" style="width:280px" value="'+download_url+'"><button type="button" id="copy_url" data-clipboard-text="'+download_url+'" class="btn btn-success btn-sm btn-title copy_url" style="margin-right:5px" data-clipboard-target="#copy_url"><img style="width:16px" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABIUlEQVQ4T6XTsSuFURjH8d+3/AFm0x0MyqBEUQaUIqUU3YwWyqgMptud/BlMSt1SBiklg0K3bhmUQTFZDZTxpyOvznt7z3sG7/T2vOf5vM85z3nQPx+KfNuHkhoZ7xXYjNfEwIukXUnvNcg2sJECnoHhugpsnwBN21PAXVgbV/AEjNhuVSFA23YHWLNt4Cc3Bh6BUdtLcbzAgHPbp8BqCngAxjJbOANWUkAPGA8fE8icpD1gOQV0gclMBRfAYgq4BaZtz/YhA5IGgY7tS2AhBdwAM7b3JX1I+iz1G45sXwHzKeAa6P97qZgcEA6v/ZsR3v9aHCmt0P9UBVuShjKz8CYpXPkDYKJ0kaKhWpe0UwOFxDATx5VACFZ0Ivbuga8i8A3NFqQRZ5pz7wAAAABJRU5ErkJggg=="></button><button type="button" class="btn btn-success QR_code btn-sm btn-title"><img  style="width:16px" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABUklEQVQ4T6WSIU9DQRCEvwlYLIoEgwEECs3rDyCpobbtL6AKRyggMQ9TJBjUMzgMCeUnIEAREoICFAoEZMk2dy/Xo4KGNZu7nZ2bnT3xz1DsN7MFYCnhe5V0n/Kb2QowL2kY70cEoXAHVEnDG/ABXAJXmVDHVZKqSFAA58AqsAY8AW3A68/AQ7hbBG6BbeDGlaQEh8AucA3suzDgC5gFXHID2At5YxJBNwA6ocFBM8B3OL8DTaCcpMDN2QojxHHdk9Qrx9SeAyf1CMFIJ3DjYqxLOgo192gs4ibSNfrMOaj2yBvMrCnpImYHR4C/vizpIPkX/mpbUtfMepJKMxtKKsyslNTLCZxkBzgFjoE5oCVp08yKvyhwgkGyRl9nX1LDzDz3kzxS8kuBpFYygq8xJ4gjjBMEpz+BF+AxcXLg39XMOpLOciW1gtz9ac71GqdpSrE/8U20EQ3XLHEAAAAASUVORK5CYII="></button></div></div><div class="line external_link" style="'+(""==data.password?"display:none;":"display:block")+'"><span class="tname">提取码</span><div class="info-r"><input readonly class="bt-input-text mr5" type="text" style="width:243px" value="'+data.password+'"><button type="button" data-clipboard-text="链接:'+download_url+" 提取码:"+data.password+'"  class="btn btn-success copy_paw btn-sm btn-title">复制链接及提取码</button></div></div><div class="line"><span class="tname">过期时间</span><div class="info-r"><span style="line-height:32px; display: block;font-size:14px">'+(data.expire>new Date("2099-01-01 00:00:00").getTime()/1e3?'<span calss="btlink">永久有效</span>':bt.format_data(data.expire))+'</span></div></div><div class="bt-form-submit-btn"><button type="button" class="btn btn-danger btn-sm btn-title layer_close">'+lan.public.close+'</button><button type="button" id="down_del" class="btn btn-danger btn-sm btn-title close_down" style="color:#fff;background-color:#c9302c;border-color:#ac2925;" onclick="">关闭分享外链</button></div></div>',success:function(layers,index){var copy_url=new ClipboardJS(".copy_url"),copy_paw=new ClipboardJS(".copy_paw");copy_url.on("success",(function(e){layer.msg("复制链接成功!",{icon:1}),e.clearSelection()})),copy_paw.on("success",(function(e){layer.msg("复制链接及提取码成功!",{icon:1}),e.clearSelection()})),$(".layer_close").click((function(){layer.close(index)})),$(".QR_code").click((function(){layer.closeAll("tips"),layer.tips('<div style="height:140px;width:140px;padding:8px 0" id="QR_code"></div>',".QR_code",{area:["150px","150px"],tips:[1,"#ececec"],time:0,shade:[.05,"#000"],shadeClose:!0,success:function(){jQuery("#QR_code").qrcode({render:"canvas",text:download_url,height:130,width:130})}})})),$(".close_down").click((function(){that.remove_download_url({id:data.id,fileName:data.filename},(function(res){that.loadY.close(),"fonticon"==type&&(that.file_list[datas.index].down_id=0,that.reader_file_list_content(that.file_list)),"list"==type&&that.render_share_list(),layer.msg(res.msg,{icon:res.status?1:2})}))}))}})},del_file_or_dir:function(data){var that=this;that.is_recycle?bt.confirm({title:"删除"+data.type_tips+"[&nbsp;"+data.filename+"&nbsp;]",msg:"<span>您确定要删除该"+data.type_tips+"[&nbsp;"+data.path+"&nbsp;]吗，删除后将移至回收站，是否继续操作?</span>"},(function(){that.del_file_req(data,(function(res){that.reader_file_list({path:that.file_path}),layer.msg(res.msg,{icon:res.status?1:2})}))})):bt.show_confirm("删除"+data.type_tips+"[&nbsp;"+data.filename+"&nbsp;]",'<i style="font-size: 15px;font-style: initial;color: red;">当前未开启回收站，删除该'+("dir"==data.type?"文件夹":"文件")+"后将无法恢复，是否继续删除？</i></span>",(function(){that.del_file_req(data,(function(res){that.reader_file_list({path:that.file_path}),layer.msg(res.msg,{icon:res.status?1:2})}))}))},cancel_file_favorites:function(data){var that=this,index=data.index;this.loadY=bt.confirm({title:"取消"+data.filename+"收藏",msg:"是否取消["+data.path+"]的收藏，是否继续？"},(function(){that.$http("del_files_store",{path:data.path},(function(res){res.status&&(that.file_list[index].caret=!1,that.reader_file_list_content(that.file_list),that.load_favorites_index_list()),layer.msg(res.msg,{icon:res.status?1:2})}))}))},set_file_authority:function(data,isPatch){var that=this;that.get_file_authority({path:data.path},(function(rdata){that.loadY=layer.open({type:1,closeBtn:2,title:lan.files.set_auth+"["+data.filename+"]",area:"400px",shadeClose:!1,content:'<div class="setchmod bt-form ptb15 pb70">                            <fieldset>                                <legend>'+lan.files.file_own+'</legend>                                <p><input type="checkbox" id="owner_r" />'+lan.files.file_read+'</p>                                <p><input type="checkbox" id="owner_w" />'+lan.files.file_write+'</p>                                <p><input type="checkbox" id="owner_x" />'+lan.files.file_exec+"</p>                            </fieldset>                            <fieldset>                                <legend>"+lan.files.file_group+'</legend>                                <p><input type="checkbox" id="group_r" />'+lan.files.file_read+'</p>                                <p><input type="checkbox" id="group_w" />'+lan.files.file_write+'</p>                                <p><input type="checkbox" id="group_x" />'+lan.files.file_exec+"</p>                            </fieldset>                            <fieldset>                                <legend>"+lan.files.file_public+'</legend>                                <p><input type="checkbox" id="public_r" />'+lan.files.file_read+'</p>                                <p><input type="checkbox" id="public_w" />'+lan.files.file_write+'</p>                                <p><input type="checkbox" id="public_x" />'+lan.files.file_exec+'</p>                            </fieldset>                            <div class="setchmodnum"><input class="bt-input-text" type="text" id="access" maxlength="3" value="'+rdata.chmod+'">'+lan.files.file_menu_auth+"，                            <span>"+lan.files.file_own+'                            <select id="chown" class="bt-input-text">                                <option value="www" '+("www"==rdata.chown?'selected="selected"':"")+'>www</option>                                <option value="mysql" '+("mysql"==rdata.chown?'selected="selected"':"")+'>mysql</option>                                <option value="root" '+("root"==rdata.chown?'selected="selected"':"")+'>root</option>                            </select></span>                            <span><input type="checkbox" id="accept_all" checked /><label for="accept_all" style="position: absolute;margin-top: 4px; margin-left: 5px;font-weight: 400;">应用到子目录</label></span>                            </div>                            <div class="bt-form-submit-btn">                                <button type="button" class="btn btn-danger btn-sm btn-title layer_close">'+lan.public.close+'</button>                                <button type="button" class="btn btn-success btn-sm btn-title set_access_authority">'+lan.public.ok+"</button>                            </div>                        </div>",success:function(index,layers){that.edit_access_authority(),$("#access").keyup((function(){that.edit_access_authority()})),$("input[type=checkbox]").change((function(){for(var idName=["owner","group","public"],onacc="",n=0;n<idName.length;n++){var access=0;access+=$("#"+idName[n]+"_x").prop("checked")?1:0,access+=$("#"+idName[n]+"_w").prop("checked")?2:0,onacc+=access+=$("#"+idName[n]+"_r").prop("checked")?4:0}$("#access").val(onacc)})),$(".set_access_authority").click((function(){var chmod=$("#access").val(),chown,all,_form={};_form={user:$("#chown").val(),access:chmod,all:$("#accept_all").prop("checked")?"True":"False"},isPatch?(_form.type=data.type,_form.path=data.path,_form.data=data.filelist):_form.filename=data.path,that.$http(isPatch?"SetBatchData":"SetFileAccess",_form,(function(res){res.status&&(layer.close(layers),that.reader_file_list({path:that.file_path,is_operating:!1})),layer.msg(res.msg,{icon:res.status?1:2})}))})),$(".layer_close").click((function(){layer.close(layers)}))}})}))},get_present_task_view:function(){this.file_present_task=layer.open({type:1,title:"实时任务队列",area:"500px",closeBtn:2,skin:"present_task_list",shadeClose:!1,shade:!1,offset:"auto",content:'<div style="margin: 10px;" class="message-list"></div>'})},render_present_task_list:function(){var that=this;this.get_task_req({status:-3},(function(lists){if(0==lists.length)return layer.close(that.file_present_task),that.file_present_task=null,void that.reader_file_list({path:that.file_path,is_operating:!1});var task_body="",is_add=!1;$.each(lists,(function(index,item){-1==item.status?(that.file_present_task||that.get_present_task_view(),"1"==item.type?task_body+='<div class="mw-con">                            <ul class="waiting-down-list">                                <li>                                    <div class="down-filse-name"><span class="fname" style="width:80%;" title="正在下载: '+item.shell+'">正在下载: '+item.shell+'</span><span style="position: absolute;left: 84%;top: 25px;color: #999;">'+item.log.pre+'%</span><span class="btlink" onclick="bt_file.remove_present_task('+item.id+')" style="position: absolute;top: 25px;right: 20px;">取消</span></div>                                    <div class="down-progress"><div class="done-progress" style="width:'+item.log.pre+'%"></div></div>                                    <div class="down-info"><span class="total-size"> '+item.log.used+"/"+ToSize(item.log.total)+'</span><span class="speed-size">'+(0==item.log.speed?"正在连接..":item.log.speed)+'/s</span><span style="margin-left: 20px;">预计还要: '+item.log.time+"</span></div>                                </li>                            </ul>                            </div>":task_body+='<div class="mw-title"><span style="max-width: 88%;display: block;overflow: hidden;text-overflow: ellipsis;white-space: nowrap;">'+item.name+": "+item.shell+'</span><span class="btlink" onclick="bt_file.remove_present_task('+item.id+')"  style="position: absolute;top: 10px;right: 15px;">取消</span></div>                        <div class="mw-con codebg">                            <code>'+item.log+"</code>                        </div>"):(is_add||(task_body+='<div class="mw-title">等待执行任务</div><div class="mw-con"><ul class="waiting-list">',is_add=!0),task_body+='<li><span class="wt-list-name" style="width: 90%;">'+item.name+": "+item.shell+'</span><span class="mw-cancel" onclick="bt_file.remove_present_task('+item.id+')">X</span></li>')})),that.file_present_task&&(is_add&&(task_body+="</ul></div>"),$(".message-list").html(task_body)),setTimeout((function(){that.render_present_task_list()}),1e3)}))},remove_present_task:function(id){var that=this;layer.confirm("是否取消上传当前列表的文件，若取消上传，已上传的文件，需用户手动删除，是否继续？",{title:"取消上传文件",icon:0},(function(indexs){bt.send("remove_task","task/remove_task",{id:id},(function(rdata){layer.msg(rdata.msg,{icon:1}),layer.close(that.file_present_task),that.file_present_task=null})),layer.close(indexs)}))},edit_access_authority:function(){for(var access=$("#access").val(),idName=["owner","group","public"],n=0;n<idName.length;n++)$("#"+idName[n]+"_x").prop("checked",!1),$("#"+idName[n]+"_w").prop("checked",!1),$("#"+idName[n]+"_r").prop("checked",!1);for(var i=0;i<access.length;i++){var onacc=access.substr(i,1);if(!(i>idName.length))switch(onacc>7&&$("#access").val(access.substr(0,access.length-1)),onacc){case"1":$("#"+idName[i]+"_x").prop("checked",!0);break;case"2":$("#"+idName[i]+"_w").prop("checked",!0);break;case"3":$("#"+idName[i]+"_x").prop("checked",!0),$("#"+idName[i]+"_w").prop("checked",!0);break;case"4":$("#"+idName[i]+"_r").prop("checked",!0);break;case"5":$("#"+idName[i]+"_r").prop("checked",!0),$("#"+idName[i]+"_x").prop("checked",!0);break;case"6":$("#"+idName[i]+"_r").prop("checked",!0),$("#"+idName[i]+"_w").prop("checked",!0);break;case"7":$("#"+idName[i]+"_r").prop("checked",!0),$("#"+idName[i]+"_w").prop("checked",!0),$("#"+idName[i]+"_x").prop("checked",!0)}}},get_file_authority:function(data,callback){this.$http("GetFileAccess",{filename:data.path},(function(rdata){callback&&callback(rdata)}))},set_dir_kill:function(data){var that=this;"php"==data.ext?that.$http("file_webshell_check",{filename:data.path},(function(rdata){layer.msg(rdata.msg,{icon:rdata.status?1:2})})):layer.confirm("目录查杀将包含子目录中的php文件，是否操作？",{title:"目录查杀["+data.filename+"]",closeBtn:2,icon:3},(function(index){that.$http("dir_webshell_check",{path:data.path},(function(rdata){layer.msg(rdata.msg,{icon:rdata.status?1:2})}))}))},path_resolve:function(paths,param){var path="",split="";return Array.isArray(param)||(param=[param]),paths.replace(/([\/|\/]*)$/,(function($1){return split=$1,"www"})),$.each(param,(function(index,item){path+="/"+item})),paths+path},get_ext_name:function(fileName){for(var extArr=fileName.split("."),exts=["folder","folder-unempty","sql","c","cpp","cs","flv","css","js","htm","html","java","log","mht","php","url","xml","ai","bmp","cdr","gif","ico","jpeg","jpg","JPG","png","psd","webp","ape","avi","mkv","mov","mp3","mp4","mpeg","mpg","rm","rmvb","swf","wav","webm","wma","wmv","rtf","docx","fdf","potm","pptx","txt","xlsb","xlsx","7z","cab","iso","rar","zip","gz","bt","file","apk","bookfolder","folder-empty","fromchromefolder","documentfolder","fromphonefolder","mix","musicfolder","picturefolder","videofolder","sefolder","access","mdb","accdb","fla","doc","docm","dotx","dotm","dot","pdf","ppt","pptm","pot","xls","csv","xlsm"],extLastName=extArr[extArr.length-1],i=0;i<exts.length;i++)if(exts[i]==extLastName)return exts[i];return"file"},get_path_filename:function(path){var paths=path.split("/");return paths[paths.length-1]},retrun_prev_path:function(path){var dir_list=path.split("/");return dir_list.splice(dir_list.length-1),""==dir_list&&(dir_list=["/"]),dir_list.join("/")},path_check:function(path){return"/"===(path=path.replace("//","/"))?path:path=path.replace(/\/+$/g,"")},get_file_access:function(data,callback){var that=this;this.layerT=bt.load("正在文件权限信息，请稍候..."),bt.send("GetFileAccess","files/GetFileAccess",{path:data.path},(function(res){that.loadT.close(),callback&&callback()}))},create_download_url:function(data,callback){var that=this;this.layerT=bt.load("正在分享文件，请稍候..."),bt.send("create_download_url","files/create_download_url",{filename:data.filename,ps:data.ps,password:data.password,expire:data.expire},(function(res){that.layerT.close(),callback&&callback(res)}))},get_download_url_find:function(data,callback){var that=this;this.layerT=bt.load("正在获取分享文件信息，请稍候..."),bt.send("get_download_url_find","files/get_download_url_find",{id:data.id},(function(res){that.layerT.close(),callback&&callback(res)}))},remove_download_url:function(data,callback){var that=this;layer.confirm("是否取消分享该文件【"+data.fileName+"】，是否继续？",{title:"取消分享",closeBtn:2,icon:3},(function(){this.layerT=bt.load("正在取消分享文件，请稍候..."),bt.send("remove_download_url","files/remove_download_url",{id:data.id},(function(res){callback&&callback(res)}))}))},get_disk_list:function(callback){var that=this;this.layerT=bt.load("正在获取磁盘列表，请稍候..."),bt.send("GetDiskInfo","system/GetDiskInfo",{},(function(res){that.layerT.close(),callback&&callback(res)}))},create_file_req:function(data,callback){var _req="folder"===data.type?"CreateDir":"CreateFile";bt.send(_req,"files/"+_req,{path:data.path},(function(res){callback&&callback(res)}))},rename_file_req:function(data,callback){bt.send("MvFile","files/MvFile",{sfile:data.sfile,dfile:data.dfile,rename:data.rename||!0},(function(res){callback&&callback(res)}))},shear_file_req:function(data,callback){this.rename_file_req({sfile:data.sfile,dfile:data.dfile,rename:!1},(function(res){callback&&callback(res)}))},check_exists_files_req:function(data,callback){var layerT=bt.load("正在粘贴文件，请稍候...");bt.send("CheckExistsFiles","files/CheckExistsFiles",{dfile:data.dfile,filename:data.filename},(function(res){layerT.close(),callback&&callback(res)}))},copy_file_req:function(data,callback){bt.send("CopyFile","files/CopyFile",{sfile:data.sfile,dfile:data.dfile},(function(res){callback&&callback(res)}))},compress_file_req:function(data,callback){bt.send("Zip","files/Zip",{sfile:data.sfile,dfile:data.dfile,z_type:data.z_type,path:data.path},(function(res){callback&&callback(res)}))},get_task_req:function(data,callback){bt.send("get_task_lists","task/get_task_lists",{status:data.status},(function(res){callback&&callback(res)}))},get_file_access:function(){bt.send("GetFileAccess","files/GetFileAccess",{filename:data.filename},(function(res){callback&&callback(res)}))},set_file_access:function(){bt.send("SetFileAccess","files/SetFileAccess",{filename:data.filename,user:data.user,access:data.access,all:data.all},(function(res){callback&&callback(res)}))},del_file_req:function(data,callback){var _req="dir"===data.type?"DeleteDir":"DeleteFile",layerT=bt.load("正在删除文件，请稍候...");bt.send(_req,"files/"+_req,{path:data.path},(function(res){layerT.close(),layer.msg(res.msg,{icon:res.status?1:2}),callback&&callback(res)}))},down_file_req:function(data,callback){window.open("/download?filename="+encodeURIComponent(data.path))},get_file_size:function(data,callback){this.$http({tips:"正在获取文件目录大小，请稍候...",method:"get_path_size",data:{path:data.path}},callback)},get_dir_size:function(data){layer.msg("正在计算，请稍候",{icon:16,time:0,shade:[.3,"#000"]}),$.post("/files?action=GetDirSize","path="+data.path,(function(rdata){layer.closeAll(),$("#file_all_size").text(rdata)}))},get_dir_list:function(data,callback){var that=this,f_sort=bt.get_cookie("files_sort");f_sort&&(data.sort=f_sort,data.reverse=bt.get_cookie("name_reverse")),bt.send("GetDir","files/GetDir",$.extend({p:1,showRow:bt.get_storage("local","showRow")||this.file_page_num,path:bt.get_cookie("Path")||data.path},data),(function(res){callback&&callback(res)}))},compress_file_or_dir:function(data,isbatch){var that=this;this.reader_form_line({url:"Zip",overall:{width:"310px"},data:[{label:"压缩类型",type:"select",name:"z_type",value:data.open,list:[["tar_gz","tar.gz (推荐)"],["zip","zip (通用格式)"],["rar","rar (WinRAR对中文兼容较好)"]]},{label:"压缩路径",id:"compress_path",name:"dfile",placeholder:"URL地址",value:data.path+"."+("tar_gz"==data.open?"tar.gz":data.open)}],beforeSend:function(updata){var ind=data.path.lastIndexOf("/"),_url=data.path.substring(0,ind+1);return{sfile:data.filename,dfile:updata.dfile,z_type:"tar_gz"==updata.z_type?"tar.gz":updata.z_type,path:_url}}},(function(form,html){var loadT=layer.open({type:1,title:"压缩文件",area:"480px",shadeClose:!1,closeBtn:2,skin:"compress_file_view",btn:["压缩","关闭"],content:html[0].outerHTML,success:function(){$("select[name=z_type]").change((function(){var _type=$(this).val(),_inputVel=$("input[name=dfile]").val(),path_list=[];path_list=(_inputVel=_inputVel.substring(0,_inputVel.lastIndexOf("/"))).split("/"),$("input[name=dfile]").val(_inputVel+"/"+(isbatch?path_list[path_list.length-1]:data.filename)+"."+_type)})),$(".compress_file_view .line:nth-child(2)").find(".info-r").append('<span class="glyphicon glyphicon-folder-open cursor" style="margin-left: 10px;" onclick="ChangePath(\'compress_path\')"></span>')},yes:function(){var ress;if(""==form.getVal().dfile)return layer.msg("请选择有效的地址",{icon:2});form.submitForm((function(res,datas){setTimeout((function(){that.reader_file_list({path:datas.path})}),1e3),null!=res&&null!=res||layer.msg(lan.files.zip_ok,{icon:1}),res.status&&that.render_present_task_list(),layer.close(loadT)}))}})}))},unpack_file_to_path:function(data){var that=this,_type="zip",spath="";spath=data.path.substring(0,data.path.lastIndexOf("/")),this.reader_form_line({url:"UnZip",overall:{width:"310px"},data:[{label:"文件名",name:"z_name",placeholder:"压缩文件名",value:data.path},{label:"解压到",name:"z_path",placeholder:"解压路径",value:spath},{label:"编码",name:"z_code",type:"select",value:"UTF-8",list:[["UTF-8","UTF-8"],["gb18030","GBK"]]}],beforeSend:function(updata){return{sfile:updata.z_name,dfile:updata.z_path,type:_type,coding:updata.z_code,password:updata.z_password}}},(function(form,html){var loadT=layer.open({type:1,title:"解压文件",area:"480px",shadeClose:!1,closeBtn:2,skin:"unpack_file_view",btn:["解压","关闭"],content:html[0].outerHTML,success:function(){"gz"==data.ext&&(_type="tar"),"zip"==_type&&$(".unpack_file_view .line:nth-child(2)").append('<div class="line"><span class="tname">解压密码</span><div class="info-r"><input type="text" name="z_password" class="bt-input-text " placeholder="无密码则留空" style="width:310px" value=""></div></div>')},yes:function(){var ress=form.getVal();return""==ress.z_name?layer.msg("请输入文件名路径",{icon:2}):""==ress.z_path?layer.msg("请输入解压地址",{icon:2}):void form.submitForm((function(res,datas){layer.close(loadT),setTimeout((function(){that.reader_file_list({path:datas.path})}),1e3),res.status&&that.render_present_task_list(),layer.msg(res.msg,{icon:res.status?1:2})}))}})}))},match_unqualified_string:function(item){var containSpecial;return RegExp(/[(\ )(\*)(\|)(\\)(\:)(\")(\/)(\<)(\>)(\?)(\)]+/).test(item)},reader_form_line:function(config,callback){var that=this,random=bt.get_random(10),html=$('<form id="'+random+'" class="bt-form pd20"></form>'),data=config,eventList=[],that=this;Array.isArray(config)||(data=config.data),$.each(data,(function(index,item){var labelWidth=item.labelWidth||config.overall.labelWidth||null,event_random=bt.get_random(10),width=item.labelWidth||config.overall.width||null,form_line=$('<div class="line"><span class="tname" '+(labelWidth?"width:"+labelWidth:"")+">"+(item.label||"")+'</span><div class="info-r"></div></div>'),form_el=$(function(){switch(item.type){case"select":return"<select "+(item.disabled?"disabled":"")+" "+(item.readonly?"readonly":"")+' class="bt-input-text mr5 '+(item.readonly?"readonly-form-input":"")+'" name="'+item.name+'" '+(item.eventType?'data-event="'+event_random+'"':"")+' style="'+(width?"width:"+width:"")+'">'+function(item){var options_list="";return $.each(item.list,(function(key,items){Array.isArray(items)?options_list+='<option value="'+items[0]+'" '+(item.value===items[0]?"selected":"")+">"+items[1]+"</option>":options_list+='<option value="'+items+'" '+(item.value===key?"selected":"")+">"+items+"</option>"})),options_list}(item)+"</select>";case"text":default:return"<input "+(item.disabled?"disabled":"")+" "+(item.readonly?"readonly":"")+" "+(item.eventType?'data-event="'+event_random+'"':"")+' type="text" name="'+item.name+'" '+(item.id?'id="'+item.id+'"':"")+' class="bt-input-text '+(item.readonly?"readonly-form-input":"")+'" placeholder="'+(item.placeholder||"")+'" style="'+(width?"width:"+width:"")+'" value="'+(item.value||"")+'"/>'}}(item));(item.eventType||item.event)&&(Array.isArray(item.eventType)||(item.eventType=[item.eventType]),$.each(item.eventType,(function(index,items){if(eventList.push({el:event_random,type:items||"click",event:item[items]||null}),config.el){var els=$('[data-event="'+item.el+'"]');if(item[items])"enter"==items?els.on("keyup",(function(e){13==e.keyCode&&item.event(e)})):els.on(item||"click",item.event);else if("focus"==items){var vals=els.val();""!=vals&&els.val("").focus().val(vals)}else els[items]()}}))),form_line.find(".info-r").append(form_el),html.append(form_line)})),config.el&&$(config.el).empty().append(html),callback&&callback({getVal:function(){return $("#"+random).serializeObject()},setEvent:function(){$.each(eventList,(function(index,item){var els=$('[data-event="'+item.el+'"]');if(null===item.event)if("focus"==item.type){var vals=els.val();""!=vals&&els.val("").focus().val(vals)}else els[item.type]();else"enter"==item.type?els.on("keyup",(function(e){13==e.keyCode&&item.event(e)})):els.on(item.type,item.event)}))},submitForm:function(callback){var data=this.getVal();config.beforeSend&&(data=config.beforeSend(data)),that.loadT=bt.load("正在提交表单内容，请稍候..."),bt.send(config.url,"files/"+config.url,data,(function(rdata){that.loadT.close(),callback&&callback(rdata,data)}))}},html)},$http:function(data,parem,callback){var that=this,loadT="";"string"==typeof data?("object"!=typeof parem&&(callback=parem,parem={}),Array.isArray(this.method_list[data])||(this.method_list[data]=["files",this.method_list[data]]),this.$http({method:data,tips:!!this.method_list[data][1]&&"正在"+this.method_list[data][1]+"，请稍候...",module:this.method_list[data][0],data:parem,msg:!0},callback)):(void 0!==data.tips&&data.tips&&(loadT=bt.load(data.tips)),bt.send(data.method,(data.module||"files")+"/"+data.method,data.data||{},(function(res){if(""!=loadT&&loadT.close(),"string"==typeof res&&(res=JSON.parse(res)),!1===res.status&&res.msg)return bt.msg(res),!1;parem&&parem(res)})))}};bt_file.file_drop={startTime:0,endTime:0,uploadLength:0,splitSize:2097152,splitEndTime:0,splitStartTime:0,fileSize:0,speedLastTime:0,filesList:[],errorLength:0,isUpload:!0,uploadSuspend:[],isUploadNumber:800,uploadAllSize:0,uploadedSize:0,updateedSizeLast:0,topUploadedSize:0,uploadExpectTime:0,initTimer:0,speedInterval:null,timerSpeed:0,isLayuiDrop:!1,uploading:!1,is_webkit:navigator.userAgent.indexOf("WebKit")>-1,init:function(){0==$("#mask_layer").length&&(window.UploadFiles=function(){bt_file.file_drop.dialog_view()},$("body").append($('<div class="mask_layer" id="mask_layer" style="position:fixed;top:0;left:0;right:0;bottom:0; background:rgba(255,255,255,0.6);border:3px #ccc dashed;z-index:99999999;display:none;color:#999;font-size:40px;text-align:center;overflow:hidden;"><span style="position: absolute;top: 50%;left: 50%;margin-left: -300px;margin-top: -40px;">上传文件到当前目录下'+(this.is_webkit?"":'<i style="font-size:20px;font-style:normal;display:block;margin-top:15px;color:red;">当前浏览器暂不支持拖动上传，推荐使用Chrome浏览器或WebKit内核的浏览。</i>')+"</span></div>")),this.event_relation(document.querySelector("#container"),document,document.querySelector("#mask_layer")))},event_relation:function(enter,leave,drop){var that=this,obj=Object.keys(arguments);for(var item in arguments)"object"==typeof arguments[item]&&void 0!==arguments[item].nodeType&&(arguments[item]={el:arguments[item],callback:null});leave.el.addEventListener("dragleave",null!=leave.callback?leave.callback:function(e){0==e.x&&0==e.y&&$("#mask_layer").hide(),e.preventDefault()},!1),enter.el.addEventListener("dragenter",null!=enter.callback?enter.callback:function(e){if("string"==e.dataTransfer.items[0].kind)return!1;$("#mask_layer").show(),that.isLayuiDrop=!1,e.preventDefault()},!1),drop.el.addEventListener("dragover",(function(e){e.preventDefault()}),!1),drop.el.addEventListener("drop",null!=enter.callback?drop.callback:that.ev_drop,!1)},ev_drop:function(e){if("string"==e.dataTransfer.items[0].kind)return!1;if(!bt_file.file_drop.is_webkit)return $("#mask_layer").hide(),!1;if(e.preventDefault(),bt_file.file_drop.uploading)return layer.msg("正在上传文件中，请稍候..."),!1;var items=e.dataTransfer.items,time,num=0;if(loadT=layer.msg("正在获取上传文件信息，请稍候...",{icon:16,time:0,shade:.3}),bt_file.file_drop.isUpload=!0,items&&items.length&&null!=items[0].webkitGetAsEntry&&"file"!=items[0].kind)return!1;null==bt_file.file_drop.filesList&&(bt_file.file_drop.filesList=[]);for(var i=bt_file.file_drop.filesList.length-1;i>=0;i--)bt_file.file_drop.filesList[i].is_upload&&bt_file.file_drop.filesList.splice(-i,1);function update_sync(s){s.getFilesAndDirectories().then((function(subFilesAndDirs){return iterateFilesAndDirs(subFilesAndDirs,s.path)}))}$("#mask_layer").hide();var iterateFilesAndDirs=function(filesAndDirs,path){if(!bt_file.file_drop.isUpload)return!1;for(var i=0;i<filesAndDirs.length;i++)if("function"==typeof filesAndDirs[i].getFilesAndDirectories)update_sync(filesAndDirs[i]);else{if(num>bt_file.file_drop.isUploadNumber)return bt_file.file_drop.isUpload=!1,layer.msg(" "+bt_file.file_drop.isUploadNumber+"份，无法上传,请压缩后上传!。",{icon:2,area:"405px"}),bt_file.file_drop.filesList=[],clearTimeout(time),!1;bt_file.file_drop.filesList.push({file:filesAndDirs[i],path:bt.get_file_path(path+"/"+filesAndDirs[i].name).replace("//","/"),name:filesAndDirs[i].name.replace("//","/"),icon:bt_file.get_ext_name(filesAndDirs[i].name),size:bt_file.file_drop.to_size(filesAndDirs[i].size),upload:0,is_upload:!1}),bt_file.file_drop.uploadAllSize+=filesAndDirs[i].size,clearTimeout(time),time=setTimeout((function(){layer.close(loadT),bt_file.file_drop.dialog_view()}),100),num++}};"getFilesAndDirectories"in e.dataTransfer&&e.dataTransfer.getFilesAndDirectories().then((function(filesAndDirs){return iterateFilesAndDirs(filesAndDirs,"/")}))},dialog_view:function(config){var that=this,html="";if(!$(".file_dir_uploads").length>0){null==that.filesList&&(that.filesList=[]);for(var i=0;i<that.filesList.length;i++){var item;html+='<li><div class="fileItem"><span class="filename" title="文件路径:'+((item=that.filesList[i]).path+"/"+item.name).replace("//","/")+"&#10;文件类型:"+item.file.type+"&#10;文件大小:"+item.size+'"><i class="ico ico-'+item.icon+'"></i>'+(item.path+"/"+item.name).replace("//","/")+'</span><span class="filesize">'+item.size+'</span><span class="fileStatus">'+that.is_upload_status(item.upload)+'</span></div><div class="fileLoading"></div></li>'}var is_show=that.filesList.length>11;layer.open({type:1,closeBtn:1,maxmin:!0,area:["590px","505px"],btn:["开始上传","取消上传"],title:"上传文件到【"+bt.get_cookie("Path")+"】--- 支持断点续传",skin:"file_dir_uploads",content:'<div style="padding:15px 15px 10px 15px;"><div class="upload_btn_groud"><div class="btn-group"><button type="button" class="btn btn-primary btn-sm upload_file_btn">上传文件</button><button type="button" class="btn btn-primary  btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="caret"></span><span class="sr-only">Toggle Dropdown</span></button><ul class="dropdown-menu"><li><a href="#" data-type="file">上传文件</a></li><li><a href="#" data-type="dir">上传目录</a></li></ul></div><div class="file_upload_info" style="display:none;"><span>总进度&nbsp;<i class="uploadProgress"></i>,正在上传&nbsp;<i class="uploadNumber"></i>,</span><span style="display:none">上传失败&nbsp;<i class="uploadError"></i></span><span>上传速度&nbsp;<i class="uploadSpeed">获取中</i>,</span><span>预计上传时间&nbsp;<i class="uploadEstimate">获取中</i></span><i></i></div></div><div class="upload_file_body '+(""==html?"active":"")+'">'+(""!=html?'<ul class="dropUpLoadFileHead" style="padding-right:'+(is_show?"15":"0")+'px"><li class="fileTitle"><span class="filename">文件名</span><span class="filesize">文件大小</span><span class="fileStatus">上传状态</span></li></ul><ul class="dropUpLoadFile list-list">'+html+"</ul>":"<span>请将需要上传的文件拖到此处"+(that.is_webkit?"":'<i style="display: block;font-style: normal;margin-top: 10px;color: red;font-size: 17px;">当前浏览器暂不支持拖动上传，推荐使用Chrome浏览器或WebKit内核的浏览。</i>')+"</span>")+"</div></div>",success:function(){$("#mask_layer").hide(),$(".file_dir_uploads .layui-layer-max").hide(),$(".upload_btn_groud .upload_file_btn").click((function(){$(".upload_btn_groud .dropdown-menu [data-type=file]").click()})),$(".upload_btn_groud .dropdown-menu a").click((function(){var type=$(this).attr("data-type");$('<input type="file" multiple="true" autocomplete="off" '+("dir"==type?'webkitdirectory=""':"")+" />").change((function(e){for(var files=e.target.files,arry=[],i=0;i<files.length;i++){var config={file:files[i],path:bt.get_file_path("/"+files[i].webkitRelativePath).replace("//","/"),icon:bt_file.get_ext_name(files[i].name),name:files[i].name.replace("//","/"),size:that.to_size(files[i].size),upload:0,is_upload:!0};that.filesList.push(config),bt_file.file_drop.uploadAllSize+=files[i].size}that.dialog_view(that.filesList)})).click()}));var el="";that.event_relation({el:$(".upload_file_body")[0],callback:function(e){$(this).hasClass("active")&&$(this).css("borderColor","#4592f0").find("span").css("color","#4592f0")}},{el:$(".upload_file_body")[0],callback:function(e){$(this).hasClass("active")&&$(this).removeAttr("style").find("span").removeAttr("style")}},{el:$(".upload_file_body")[0],callback:function(e){var active=$(".upload_file_body");active.hasClass("active")&&active.removeAttr("style").find("span").removeAttr("style"),that.ev_drop(e),that.isLayuiDrop=!0}})},yes:function(index,layero){if(!that.uploading){if(0==that.filesList.length)return layer.msg("请选择上传文件",{icon:0}),!1;$(".layui-layer-btn0").css({cursor:"no-drop",background:"#5c9e69"}).attr("data-upload","true").text("上传中"),that.upload_file(),that.initTimer=new Date,that.uploading=!0}},btn2:function(index,layero){if(that.uploading)return layer.confirm("是否取消上传当前列表的文件，若取消上传，已上传的文件，需用户手动删除，是否继续？",{title:"取消上传文件",icon:0},(function(indexs){layer.close(index),layer.close(indexs)})),!1;layer.close(index)},cancel:function(index,layero){if(that.uploading)return layer.confirm("是否取消上传当前列表的文件，若取消上传，已上传的文件，需用户手动删除，是否继续？",{title:"取消上传文件",icon:0},(function(indexs){layer.close(index),layer.close(indexs)})),!1;layer.close(index)},end:function(){that.clear_drop_stauts(!0)},min:function(){$(".file_dir_uploads .layui-layer-max").show(),$("#layui-layer-shade"+$(".file_dir_uploads").attr("times")).fadeOut()},restore:function(){$(".file_dir_uploads .layui-layer-max").hide(),$("#layui-layer-shade"+$(".file_dir_uploads").attr("times")).fadeIn()}})}else{if(null==config&&!that.isLayuiDrop)return!1;if(that.isLayuiDrop&&(config=that.filesList),$(".upload_file_body").html('<ul class="dropUpLoadFileHead" style="padding-right:'+(config.length>11?"15":"0")+'px"><li class="fileTitle"><span class="filename">文件名</span><span class="filesize">文件大小</span><span class="fileStatus">上传状态</span></li></ul><ul class="dropUpLoadFile list-list"></ul>').removeClass("active"),Array.isArray(config)){for(var i=0;i<config.length;i++){var item;html+='<li><div class="fileItem"><span class="filename" title="文件路径:'+(item=config[i]).path+"/"+item.name+"&#10;文件类型:"+item.file.type+"&#10;文件大小:"+item.size+'"><i class="ico ico-'+item.icon+'"></i>'+(item.path+"/"+item.name).replace("//","/")+'</span><span class="filesize">'+item.size+'</span><span class="fileStatus">'+that.is_upload_status(item.upload)+'</span></div><div class="fileLoading"></div></li>'}$(".dropUpLoadFile").append(html)}else $(".dropUpLoadFile").append('<li><div class="fileItem"><span class="filename" title="文件路径:'+(config.path+"/"+config.name).replace("//","/")+"&#10;文件类型:"+config.type+"&#10;文件大小:"+config.size+'"><i class="ico ico-'+config.icon+'"></i>'+(config.path+"/"+config.name).replace("//","/")+'</span><span class="filesize">'+config.size+'</span><span class="fileStatus">'+that.is_upload_status(config.upload)+'</span></div><div class="fileLoading"></div></li>')}},is_upload_status:function(status,val){switch(void 0===val&&(val=""),status){case-1:return'<span class="upload_info upload_error" title="上传失败'+(""!=val?","+val:"")+'">上传失败'+(""!=val?","+val:"")+"</span>";case 0:return'<span class="upload_info upload_primary">等待上传</span>';case 1:return'<span class="upload_info upload_success">上传成功</span>';case 2:return'<span class="upload_info upload_warning">上传中'+val+"</span>";case 3:return'<span class="upload_info upload_success">已暂停</span>'}},set_upload_view:function(index,config){var item=$(".dropUpLoadFile li:eq("+index+")"),that=this,file_info=$(".file_upload_info");0==$(".file_upload_info .uploadProgress").length&&$(".file_upload_info").html('<span>总进度&nbsp;<i class="uploadProgress"></i>,正在上传&nbsp;<i class="uploadNumber"></i>,</span><span style="display:none">上传失败&nbsp;<i class="uploadError"></i></span><span>上传速度&nbsp;<i class="uploadSpeed">获取中</i>,</span><span>预计上传时间&nbsp;<i class="uploadEstimate">获取中</i></span><i></i>'),file_info.show().prev().hide().parent().css("paddingRight",0),this.errorLength>0&&file_info.find(".uploadError").text("("+this.errorLength+"份)").parent().show(),file_info.find(".uploadNumber").html("("+this.uploadLength+"/"+this.filesList.length+")"),file_info.find(".uploadProgress").html((this.uploadedSize/this.uploadAllSize*100).toFixed(2)+"%"),1===config.upload||-1===config.upload?(this.filesList[index].is_upload=!0,this.uploadLength+=1,item.find(".fileLoading").css({width:"100%",opacity:".5",background:-1==config.upload?"#ffadad":"#20a53a21"}),item.find(".filesize").text(config.size),item.find(".fileStatus").html(this.is_upload_status(config.upload,1===config.upload?"(耗时:"+this.diff_time(this.startTime,this.endTime)+")":config.errorMsg)),item.find(".fileLoading").fadeOut(500,(function(){$(this).remove();var uploadHeight=$(".dropUpLoadFile");if(0==uploadHeight.length)return!1;uploadHeight[0].scrollHeight>uploadHeight.height()&&uploadHeight.scrollTop(uploadHeight.scrollTop()+40)}))):(item.find(".fileLoading").css("width",config.percent),item.find(".filesize").text(config.upload_size+"/"+config.size),item.find(".fileStatus").html(this.is_upload_status(config.upload,"("+config.percent+")")))},clear_drop_stauts:function(status){var time=new Date,that=this;if(!status)try{var s_peed=bt_file.file_drop.to_size(bt_file.file_drop.uploadedSize/((time.getTime()-bt_file.file_drop.initTimer.getTime())/1e3));$(".file_upload_info").html("<span>上传成功 "+this.uploadLength+"个文件,"+(this.errorLength>0?"上传失败 "+this.errorLength+"个文件，":"")+"耗时"+this.diff_time(this.initTimer,time)+",平均速度 "+s_peed+"/s</span>").append($('<i class="ico-tips-close"></i>').click((function(){$(".file_upload_info").hide().prev().show()})))}catch(e){}$(".layui-layer-btn0").removeAttr("style data-upload").text("开始上传"),$.extend(bt_file.file_drop,{startTime:0,endTime:0,uploadLength:0,splitSize:2097152,filesList:[],errorLength:0,isUpload:!1,isUploadNumber:800,uploadAllSize:0,uploadedSize:0,topUploadedSize:0,uploadExpectTime:0,initTimer:0,speedInterval:null,timerSpeed:0,uploading:!1}),clearInterval(this.speedInterval)},upload_file:function(fileStart,index){if(null==fileStart&&0==this.uploadSuspend.length&&(fileStart=0,index=0),this.filesList.length===index)return clearInterval(this.speedInterval),this.clear_drop_stauts(),bt_file.reader_file_list({path:bt_file.file_path,is_operating:!1}),!1;var that=this;that.splitEndTime=(new Date).getTime(),that.get_timer_speed(),that.splitStartTime=(new Date).getTime();var item=this.filesList[index],fileEnd="";if(null==item)return!1;fileEnd=Math.min(item.file.size,fileStart+this.splitSize),that.fileSize=fileEnd-fileStart,form=new FormData,0==fileStart&&(that.startTime=new Date,item=$.extend(item,{percent:"0%",upload:2,upload_size:"0B"})),form.append("f_path",bt.get_cookie("Path")+item.path),form.append("f_name",item.name),form.append("f_size",item.file.size),form.append("f_start",fileStart),form.append("blob",item.file.slice(fileStart,fileEnd)),that.set_upload_view(index,item),$.ajax({url:"/files?action=upload",type:"POST",data:form,async:!0,processData:!1,contentType:!1,success:function(data){"number"==typeof data?(that.set_upload_view(index,$.extend(item,{percent:(data/item.file.size*100).toFixed(2)+"%",upload:2,upload_size:that.to_size(data)})),that.uploadedSize+=fileEnd!=data?data:parseInt(fileEnd-fileStart),that.upload_file(data,index)):data.status?(that.endTime=new Date,that.uploadedSize+=parseInt(fileEnd-fileStart),that.set_upload_view(index,$.extend(item,{upload:1,upload_size:item.size})),that.upload_file(0,index+=1)):(that.set_upload_view(index,$.extend(item,{upload:-1,errorMsg:data.msg})),that.errorLength++)},error:function(e){if(void 0===that.filesList[index].req_error&&(that.filesList[index].req_error=1),that.filesList[index].req_error>2)return that.set_upload_view(index,$.extend(that.filesList[index],{upload:-1,errorMsg:"error"==e.statusText?"网络中断":e.statusText})),that.errorLength++,that.upload_file(fileStart,index+=1),!1;that.filesList[index].req_error+=1,that.upload_file(fileStart,index)}})},get_timer_speed:function(speed){var done_time=(new Date).getTime();if(done_time-this.speedLastTime>1e3){var that=this,num=0;null==speed&&(speed=200);var s_time=(this.splitEndTime-this.splitStartTime)/1e3;if(this.timerSpeed=(this.fileSize/s_time).toFixed(2),this.updateedSizeLast=this.uploadedSize,this.timerSpeed<2)return;$(".file_upload_info .uploadSpeed").text(this.to_size(isNaN(this.timerSpeed)?0:this.timerSpeed)+"/s");var estimateTime=this.time(parseInt((this.uploadAllSize-this.uploadedSize)/this.timerSpeed*1e3));isNaN(this.timerSpeed)||$(".file_upload_info .uploadEstimate").text(-1==estimateTime.indexOf("NaN")?estimateTime:"0秒"),this.speedLastTime=done_time}},time:function(date){var hours=Math.floor(date/36e5),minutes=Math.floor(date/6e4),seconds=parseInt(date%6e4/1e3),result=seconds+"秒";return minutes>0&&(result=minutes+"分钟"+seconds+"秒"),hours>0&&(result=hours+"小时"+Math.floor((date-36e5*hours)/6e4)+"分钟"),result},diff_time:function(start_date,end_date){var diff=end_date.getTime()-start_date.getTime(),minutes=Math.floor(diff/6e4),leave3,seconds=diff%6e4/1e3,result=seconds.toFixed(minutes>0?0:2)+"秒";return minutes>0&&(result=minutes+"分"+seconds.toFixed(0)+"秒"),result},to_size:function(a){for(var d=[" B"," KB"," MB"," GB"," TB"," PB"],e=1024,b=0;b<d.length;b+=1){if(a<e){var num=(0===b?a:a.toFixed(2))+d[b];return isNaN(0===b?a:a.toFixed(2))||void 0===num?"0B":num}a/=e}}},bt_file.init(),Function.prototype.delay=function(that,arry,time){return Array.isArray(arry)||(time=arry,arry=[]),void 0===time&&(time=0),setTimeout(this.apply(that,arry),time),this},jQuery.prototype.serializeObject=function(){var a,o,h,i,e;for(a=this.serializeArray(),h=(o={}).hasOwnProperty,i=0;i<a.length;i++)e=a[i],h.call(o,e.name)||(o[e.name]=e.value);return o};